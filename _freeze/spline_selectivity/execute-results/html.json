{
  "hash": "82bb08e2e381e6d12176c5066188fe85",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Spline-Based Selectivity\"\nsubtitle: \"Penalized B-spline selectivity with smoothness control\"\n---\n\n## Overview\n\nSpline-based selectivity provides a flexible, semi-parametric alternative to\nlogistic functional forms. Rather than imposing a specific shape (monotone or\ndome-shaped), a B-spline basis is used to represent selectivity as a smooth\nfunction of age, with the degree of smoothness controlled by a penalty on the\nsecond differences of the spline coefficients.\n\nThis formulation is consistent with a broader selectivity-estimation literature\nthat emphasizes flexible shape representation together with explicit\nregularization [@millar1999_size_selection; @wileman1996_ices_selectivity_manual].\nIn assessment applications, spline penalties act as the key control on effective\ncomplexity and therefore on bias-variance trade-offs [@martell2014_good_practices_tvselex].\n\n## Model definition\n\nLet $\\mathbf{B}(a)$ be a B-spline basis matrix evaluated at ages $a$, with $K$\nbasis functions and coefficient vector $\\boldsymbol{\\beta}$. The log-selectivity is\n\n$$\n\\log\\,\\text{sel}(a) = \\mathbf{B}(a)\\,\\boldsymbol{\\beta}\n$$\n\nwith selectivity normalized so the maximum equals 1:\n\n$$\n\\text{sel}(a) = \\frac{\\exp(\\mathbf{B}(a)\\,\\boldsymbol{\\beta})}\n{\\max_a \\exp(\\mathbf{B}(a)\\,\\boldsymbol{\\beta})}.\n$$\n\nSmoothness is enforced via a penalty on second differences:\n\n$$\n\\text{penalty} = \\frac{\\lambda}{2} \\sum_{k=3}^{K} (\\beta_k - 2\\beta_{k-1} + \\beta_{k-2})^2\n$$\n\nwhere $\\lambda$ controls the trade-off between fit and smoothness.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(splines)\n\nages <- seq(1, 15, by = 0.1)\n```\n:::\n\n\n## Basis visualization\n\n\n::: {.cell}\n\n```{.r .cell-code}\nK <- 6\nB <- bs(ages, df = K, degree = 3, intercept = TRUE)\nbasis_df <- as.data.frame(B) %>%\n  mutate(age = ages) %>%\n  tidyr::pivot_longer(-age, names_to = \"basis\", values_to = \"value\")\n\nggplot(basis_df, aes(x = age, y = value, color = basis)) +\n  geom_line(linewidth = 1) +\n  labs(x = \"Age\", y = \"Basis function value\",\n       title = \"B-spline basis (degree 3, K = 6)\") +\n  theme_bw(base_size = 11) +\n  theme(legend.position = \"none\", panel.grid.minor = element_blank())\n```\n\n::: {.cell-output-display}\n![B-spline basis functions for selectivity modeling (K = 6 knots).](spline_selectivity_files/figure-html/fig-spline-basis-1.png){#fig-spline-basis width=672}\n:::\n:::\n\n\n## Example curves\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspline_sel <- function(age, beta, B) {\n  log_sel <- B %*% beta\n  sel <- exp(log_sel - max(log_sel))\n  as.numeric(sel)\n}\n\nB_mat <- bs(ages, df = K, degree = 3, intercept = TRUE)\n\nexamples <- tibble(\n  name = c(\"Logistic-like\", \"Dome-shaped\", \"Bimodal\", \"Flat-topped\"),\n  beta = list(\n    c(-3, -1, 0, 1, 1, 1),\n    c(-3, -1, 0, 1, 0, -1),\n    c(-1, 1, -0.5, 0, 1, -0.5),\n    c(-3, -1, 0, 0, 0, 0)\n  )\n)\n\ncurve_data <- examples %>%\n  rowwise() %>%\n  do({\n    ex <- .\n    tibble(\n      name = ex$name,\n      age = ages,\n      selectivity = spline_sel(ages, ex$beta, B_mat)\n    )\n  }) %>%\n  ungroup()\n\nggplot(curve_data, aes(x = age, y = selectivity, color = name)) +\n  geom_line(linewidth = 1.2) +\n  scale_y_continuous(limits = c(0, 1.05)) +\n  scale_color_brewer(palette = \"Set2\", name = \"Shape\") +\n  labs(x = \"Age\", y = \"Selectivity\",\n       title = \"Spline selectivity: example shapes\") +\n  theme_bw(base_size = 11) +\n  theme(panel.grid.minor = element_blank())\n```\n\n::: {.cell-output-display}\n![Example spline selectivity curves with different coefficient vectors.](spline_selectivity_files/figure-html/fig-spline-examples-1.png){#fig-spline-examples width=672}\n:::\n:::\n\n\n## RTMB implementation\n\n*Placeholder: RTMB objective with spline coefficients as parameters, smoothness\npenalty as a tuning parameter or estimated, and MCMC sampling.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(RTMB)\n\n# Objective function skeleton\nf <- function(parms) {\n  getAll(data, parms, warn = FALSE)\n  log_sel <- B %*% beta\n  sel_hat <- exp(log_sel - max(log_sel))\n\n  # Second-difference penalty\n  K <- length(beta)\n  d2 <- beta[3:K] - 2 * beta[2:(K-1)] + beta[1:(K-2)]\n  penalty <- 0.5 * exp(log_lambda) * sum(d2^2)\n\n  nll <- penalty\n  # Add data likelihood here\n  # nll <- nll - sum(dnorm(sel_obs, sel_hat, sel_sd, log = TRUE))\n\n  ADREPORT(sel_hat)\n  nll\n}\n```\n:::\n\n",
    "supporting": [
      "spline_selectivity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}