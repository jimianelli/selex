{
  "hash": "9f925372a75cdd9f08cfb7945cbf2e2f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Time-Varying Selectivity with 2D Autoregressive Structure\"\nsubtitle: \"Separable AR1 processes in year and age via RTMB\"\n---\n\n## Overview\n\nIn many fisheries, selectivity is not constant over time. Changes in fishing\ngear, spatial effort allocation, and fish distribution can all shift the\nage-specific vulnerability pattern across years. A time-varying selectivity\nmodel captures these dynamics by allowing log-selectivity deviations to vary\nover a year $\\times$ age matrix, with temporal and ontogenetic smoothness\nenforced through a separable two-dimensional autoregressive prior.\n\nSimulation and applied studies show that assumptions about time-varying\nselectivity can strongly influence stock-status inference, particularly when the\nestimation model cannot represent the data-generating dynamics\n[@linton2011_timevarying; @martell2014_good_practices_tvselex]. Recent\nsemi-parametric methods have therefore emphasized autocorrelation across both age\nand year dimensions, directly motivating separable latent-process formulations\n[@xu2019_semiparam_ar_selex].\n\nThis formulation uses RTMB's `dautoreg` and `dseparable` functions to construct\na Kronecker-structured precision matrix, providing a computationally efficient\nand differentiable prior for the year--age deviation surface.\n\n## Model definition\n\n### Selectivity-at-age by year\n\nLet $f$ index fishery, $y$ index year, and $a$ index age. For each fishery, a\nmatrix of log-selectivity deviations $\\boldsymbol{\\epsilon}_f$ is defined over\nyears $y = 1, \\ldots, Y$ and estimated ages $a = a_{\\min}, \\ldots, a_{\\max}$:\n\n$$\n\\log s_{f,y,a} = \\epsilon_{f,y,a}\n$$\n\nThe realized selectivity is obtained by exponentiating and normalizing so that\nthe mean across ages within each year equals 1:\n\n$$\ns_{f,y,a} = \\frac{\\exp(\\epsilon_{f,y,a})}\n{\\frac{1}{a_{\\max} - a_{\\min} + 1}\\sum_{a'=a_{\\min}}^{a_{\\max}}\n\\exp(\\epsilon_{f,y,a'})}\n$$\nFor ages beyond $a_{\\max}$, selectivity may be held constant at the value for\n$a_{\\max}$ (a \"plus-group\" extension):\n\n$$\ns_{f,y,a} = s_{f,y,a_{\\max}}, \\qquad a > a_{\\max}.\n$$\n\n### Block structure for change years\n\nIn practice, selectivity is not re-estimated in every year. Instead,\n**change years** define blocks within which selectivity is constant. Let\n$\\mathbf{C}_f$ be a binary indicator matrix where $C_{f,y} = 1$ if year $y$\nstarts a new selectivity block for fishery $f$. Within a block, selectivity\nrepeats the values from the block's initial year:\n\n$$\ns_{f,y,a} =\n\\begin{cases}\ns_{f,y,a} & \\text{if } C_{f,y} = 1 \\\\\ns_{f,y-1,a} & \\text{if } C_{f,y} = 0\n\\end{cases}\n$$\n\nThis reduces the number of free parameters from $Y \\times (a_{\\max} - a_{\\min} + 1)$\nto $B_f \\times (a_{\\max} - a_{\\min} + 1)$ where $B_f$ is the number of\nselectivity blocks for fishery $f$.\n\n## Separable 2D AR1 prior\n\n### Marginal AR1 processes\n\nThe log-selectivity deviations for each fishery are assumed to follow a\nseparable two-dimensional Gaussian Markov random field (GMRF). The key idea is\nthat temporal (year) and ontogenetic (age) correlation structures are modeled\nindependently, and their joint distribution is constructed via a Kronecker\nproduct.\n\nDefine two stationary AR1 processes:\n\n**Year dimension.** For a sequence $x_1, \\ldots, x_Y$:\n\n$$\nx_y = \\rho_y\\, x_{y-1} + \\sigma_y\\,\\eta_y, \\qquad \\eta_y \\sim \\mathcal{N}(0,1)\n$$\n\nwhere $\\rho_y \\in (-1, 1)$ is the year-to-year autocorrelation. The marginal\nvariance is $\\sigma_y^2 / (1 - \\rho_y^2)$ and the precision (inverse\ncovariance) matrix for a length-$Y$ sequence is the tridiagonal matrix\n$\\mathbf{Q}_y$ with:\n\n$$\n[\\mathbf{Q}_y]_{ij} =\n\\begin{cases}\n1 + \\rho_y^2 & i = j,\\ 1 < i < Y \\\\\n1 & i = j = 1 \\text{ or } i = j = Y \\\\\n-\\rho_y & |i - j| = 1 \\\\\n0 & \\text{otherwise}\n\\end{cases}\n$$\n\nscaled by $1 / \\sigma_y^2$.\n\n**Age dimension.** Analogously, for ages $a_{\\min}, \\ldots, a_{\\max}$:\n\n$$\nz_a = \\rho_a\\, z_{a-1} + \\sigma_a\\,\\nu_a, \\qquad \\nu_a \\sim \\mathcal{N}(0,1)\n$$\n\nwith autocorrelation $\\rho_a$ and precision matrix $\\mathbf{Q}_a$ of the same\ntridiagonal form.\n\n### Kronecker product structure\n\nThe joint precision matrix for the vectorized year--age deviation\n$\\text{vec}(\\boldsymbol{\\epsilon}_f)$ is the Kronecker product:\n\n$$\n\\mathbf{Q} = \\mathbf{Q}_y \\otimes \\mathbf{Q}_a\n$$\n\nThis encodes the assumption that the year and age correlation structures are\n**separable**: the correlation between $\\epsilon_{y,a}$ and $\\epsilon_{y',a'}$\nfactorizes as\n\n$$\n\\text{Cor}(\\epsilon_{y,a},\\, \\epsilon_{y',a'}) = \\rho_y^{|y - y'|}\\,\\rho_a^{|a - a'|}\n$$\n\nThe corresponding joint covariance matrix is:\n\n$$\n\\boldsymbol{\\Sigma} = \\boldsymbol{\\Sigma}_y \\otimes \\boldsymbol{\\Sigma}_a\n$$\n\nwhere $\\boldsymbol{\\Sigma}_y$ and $\\boldsymbol{\\Sigma}_a$ are the marginal\nAR1 covariance matrices for year and age, respectively.\n\n### Marginal scale\n\nThe overall marginal standard deviation of any single element\n$\\epsilon_{f,y,a}$ is\n\n$$\n\\text{SD}(\\epsilon_{f,y,a}) = \\frac{\\sigma_f}\n{\\sqrt{1 - \\rho_{y,f}^2}\\;\\sqrt{1 - \\rho_{a,f}^2}}\n$$\n\nwhere $\\sigma_f$ is the innovation scale for fishery $f$. This quantity\n(`scale` in the RTMB code) ensures that the specified $\\sigma_f$ represents\nthe innovation standard deviation while the marginal variance accounts for\nboth autocorrelation parameters.\n\n### Log-density\n\nThe log-density of the separable GMRF, evaluated by RTMB's `dseparable`, is:\n\n$$\n\\log p(\\boldsymbol{\\epsilon}_f \\mid \\rho_y, \\rho_a, \\sigma) =\n-\\frac{YA}{2}\\log(2\\pi)\n+ \\frac{A}{2}\\log|\\mathbf{Q}_y|\n+ \\frac{Y}{2}\\log|\\mathbf{Q}_a|\n- \\frac{1}{2}\\,\\text{vec}(\\boldsymbol{\\epsilon}_f)^\\top\n\\left(\\mathbf{Q}_y \\otimes \\mathbf{Q}_a\\right)\n\\text{vec}(\\boldsymbol{\\epsilon}_f)\n$$\n\nwhere $A = a_{\\max} - a_{\\min} + 1$ is the number of estimated ages. The\nKronecker structure means the log-determinant decomposes as a sum of the\nindividual log-determinants (scaled by dimension), and the quadratic form can\nbe evaluated without materializing the full $YA \\times YA$ precision matrix.\n\n## RTMB implementation\n\nThe implementation uses `dseparable` to compose two `dautoreg` densities. The\n`dautoreg(x, phi)` function evaluates the log-density of an AR1 process with\nautocorrelation `phi`, and `dseparable(f1, f2)` constructs their Kronecker\nproduct density.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(RTMB)\n\nget_selectivity_prior <- function(rho_y, rho_a, log_sigma, par_log_sel_fya) {\n  n_sel <- length(par_log_sel_fya)\n  lp_sel <- numeric(n_sel)\n  for (f in seq_len(n_sel)) {\n    # Marginal scale: sigma / sqrt((1-rho_y^2)(1-rho_a^2))\n    scale <- exp(log_sigma[f]) /\n      sqrt(1 - rho_y[f]^2) /\n      sqrt(1 - rho_a[f]^2)\n\n    # AR1 density in year dimension\n    f1 <- function(x) dautoreg(x, phi = rho_y[f], log = TRUE)\n    # AR1 density in age dimension\n    f2 <- function(x) dautoreg(x, phi = rho_a[f], log = TRUE)\n\n    # Separable 2D density via Kronecker product\n    lp_sel[f] <- -dseparable(f1, f2)(\n      par_log_sel_fya[[f]],\n      scale = scale\n    )\n  }\n  return(lp_sel)\n}\n```\n:::\n\n\n### `dseparable` mechanics\n\nThe call `dseparable(f1, f2)(X, scale)` performs the following:\n\n1. Treats the matrix `X` (dimension $B_f \\times A$) as a 2D random field.\n2. Evaluates `f1` along each row (year marginal) and `f2` along each column\n   (age marginal).\n3. Combines them via the Kronecker identity to compute the joint log-density\n   without forming the full $B_f A \\times B_f A$ precision matrix.\n4. The `scale` parameter rescales the entire field so that the marginal\n   standard deviation matches the specified value.\n\nThis is efficient because the computational cost scales as\n$\\mathcal{O}(B_f \\cdot A)$ rather than $\\mathcal{O}((B_f \\cdot A)^3)$.\n\n### Selectivity construction\n\nThe `get_selectivity` function builds the full 3D array (fishery $\\times$\nyear $\\times$ age) from the estimated log-selectivity blocks:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_selectivity <- function(n_age, max_age, first_yr, first_yr_catch,\n                            sel_min_age_f, sel_max_age_f, sel_end_f,\n                            sel_change_year_fy, par_log_sel) {\n  n_sel  <- nrow(sel_change_year_fy)\n  n_year <- ncol(sel_change_year_fy)\n  ymin   <- first_yr_catch - first_yr + 1\n  sel_fya <- array(0, dim = c(n_sel, n_year, n_age))\n\n  for (f in seq_len(n_sel)) {\n    amin <- sel_min_age_f[f] + 1\n    amax <- sel_max_age_f[f] + 1\n    ipar <- 1\n    for (y in ymin:n_year) {\n      if (sel_change_year_fy[f, y] != 0) {\n        # New selectivity block: exponentiate and mean-normalize\n        sel_tmp <- exp(par_log_sel[[f]][ipar, ])\n        ipar <- ipar + 1\n        sel_fya[f, y, amin:amax] <- sel_tmp / mean(sel_tmp)\n        # Extend to plus group if needed\n        if (as.logical(sel_end_f[f]) && amax < max_age) {\n          for (a in (amax + 1):n_age) {\n            sel_fya[f, y, a] <- sel_fya[f, y, amax]\n          }\n        }\n      } else {\n        # Carry forward previous block\n        sel_fya[f, y, ] <- sel_fya[f, y - 1, ]\n      }\n    }\n  }\n  return(sel_fya)\n}\n```\n:::\n\n\n## Visualization\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\n\nsim_ar1_2d <- function(n_year, n_age, rho_y, rho_a, sigma, seed = 42) {\n  set.seed(seed)\n  # Simulate AR1 in year\n  y_proc <- numeric(n_year)\n  y_proc[1] <- rnorm(1, 0, sigma / sqrt(1 - rho_y^2))\n  for (t in 2:n_year) {\n    y_proc[t] <- rho_y * y_proc[t - 1] + rnorm(1, 0, sigma)\n  }\n  # Simulate AR1 in age\n  a_proc <- numeric(n_age)\n  a_proc[1] <- rnorm(1, 0, sigma / sqrt(1 - rho_a^2))\n  for (a in 2:n_age) {\n    a_proc[a] <- rho_a * a_proc[a - 1] + rnorm(1, 0, sigma)\n  }\n  # Separable: outer product + noise\n  eps <- outer(y_proc, a_proc) +\n    matrix(rnorm(n_year * n_age, 0, sigma * 0.3), n_year, n_age)\n  # Normalize each year\n  sel <- t(apply(eps, 1, function(x) {\n    ex <- exp(x)\n    ex / mean(ex)\n  }))\n  sel\n}\n\nscenarios <- list(\n  list(label = \"High year, high age\\n(rho_y=0.9, rho_a=0.8)\",\n       rho_y = 0.9, rho_a = 0.8, sigma = 0.3),\n  list(label = \"High year, low age\\n(rho_y=0.9, rho_a=0.2)\",\n       rho_y = 0.9, rho_a = 0.2, sigma = 0.3),\n  list(label = \"Low year, high age\\n(rho_y=0.2, rho_a=0.8)\",\n       rho_y = 0.2, rho_a = 0.8, sigma = 0.3),\n  list(label = \"Low year, low age\\n(rho_y=0.2, rho_a=0.2)\",\n       rho_y = 0.2, rho_a = 0.2, sigma = 0.3)\n)\n\nn_year <- 30\nn_age <- 10\nages <- 3:12\n\nall_data <- bind_rows(lapply(seq_along(scenarios), function(i) {\n  sc <- scenarios[[i]]\n  sel <- sim_ar1_2d(n_year, n_age, sc$rho_y, sc$rho_a, sc$sigma, seed = i)\n  expand_grid(year = 1:n_year, age_idx = 1:n_age) %>%\n    mutate(\n      age = ages[age_idx],\n      selectivity = as.vector(sel),\n      scenario = sc$label\n    )\n}))\n\nggplot(all_data, aes(x = age, y = year, fill = selectivity)) +\n  geom_tile() +\n  facet_wrap(~scenario, ncol = 2) +\n  scale_fill_viridis_c(name = \"Selectivity\", option = \"C\") +\n  scale_y_reverse() +\n  labs(x = \"Age\", y = \"Year\",\n       title = \"Simulated time-varying selectivity surfaces\",\n       subtitle = \"Separable AR1 in year and age dimensions\") +\n  theme_bw(base_size = 11) +\n  theme(panel.grid = element_blank(),\n        strip.text = element_text(size = 9))\n```\n\n::: {.cell-output-display}\n![Simulated 2D AR1 selectivity surfaces under different autocorrelation settings.](timevarying_selectivity_files/figure-html/fig-tv-sim-1.png){#fig-tv-sim width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_mat <- sim_ar1_2d(n_year, n_age, rho_y = 0.9, rho_a = 0.8, sigma = 0.3)\nsel_df <- expand_grid(year = 1:n_year, age_idx = 1:n_age) %>%\n  mutate(\n    age = ages[age_idx],\n    selectivity = as.vector(sel_mat)\n  ) %>%\n  filter(year %in% c(1, 5, 10, 15, 20, 25, 30))\n\nggplot(sel_df, aes(x = age, y = selectivity, color = factor(year))) +\n  geom_line(linewidth = 1) +\n  scale_color_viridis_d(name = \"Year\", option = \"D\") +\n  scale_y_continuous(limits = c(0, NA)) +\n  labs(x = \"Age\", y = \"Selectivity (mean-normalized)\",\n       title = \"Selectivity-at-age for selected years\") +\n  theme_bw(base_size = 11) +\n  theme(panel.grid.minor = element_blank())\n```\n\n::: {.cell-output-display}\n![Time-varying selectivity curves at selected years (high autocorrelation scenario).](timevarying_selectivity_files/figure-html/fig-tv-lines-1.png){#fig-tv-lines width=672}\n:::\n:::\n\n\n## Properties and considerations\n\nThe separable 2D AR1 formulation has several properties that make it attractive\nfor operational stock assessments:\n\n**Parsimony.** Three hyperparameters per fishery ($\\rho_y$, $\\rho_a$, $\\sigma$)\ncontrol the smoothness of an arbitrarily large year--age surface. The\nautocorrelation parameters shrink the effective number of free parameters well\nbelow the nominal $B_f \\times A$.\n\n**Computational efficiency.** The Kronecker structure avoids forming or\nfactorizing the full joint precision matrix. Combined with RTMB's automatic\ndifferentiation, gradients of the log-prior are computed at the same\n$\\mathcal{O}(B_f \\cdot A)$ cost as the density itself.\n\n**Interpretability.** The parameter $\\rho_y$ directly controls how quickly\nselectivity can change between years (high values produce slow drift, low\nvalues allow abrupt shifts), while $\\rho_a$ controls the smoothness of the\nselectivity curve within any single year.\n\n**Integration with block structure.** The change-year mechanism can be layered\non top: the 2D AR1 prior applies to the matrix of block-specific selectivity\npatterns, not to every individual year. This reduces dimensionality further\nwhile still allowing the prior to borrow strength across blocks.\n",
    "supporting": [
      "timevarying_selectivity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}