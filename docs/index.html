<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="James Ianelli">
<meta name="dcterms.date" content="2026-02-12">
<meta name="keywords" content="selectivity, stock assessment, RTMB, fisheries, walleye pollock">

<title>Selectivity Options for Age-Structured Stock Assessments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-a74871fe4945b66d259aafc266475145.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
<meta name="citation_title" content="Selectivity Options for Age-Structured Stock Assessments">
<meta name="citation_abstract" content="Selectivity is a fundamental component of age-structured stock assessment models,
governing how fishing mortality and survey catchability vary with age or size. The
choice of selectivity parameterization affects estimates of population abundance,
fishing mortality, and management reference points. This manuscript compares several
selectivity formulations---including standard logistic, double logistic,
spline-based, and time-varying 2D autoregressive approaches---within a unified
RTMB framework. We examine parameter
identifiability, prior sensitivity, and the practical consequences of selectivity
misspecification using simulation and application to eastern Bering Sea walleye
pollock (*Gadus chalcogrammus*). Results highlight trade-offs between flexibility
and estimability and provide guidance for practitioners choosing among selectivity
options in operational assessments.
">
<meta name="citation_keywords" content="selectivity,stock assessment,RTMB,fisheries,walleye pollock">
<meta name="citation_author" content="James Ianelli">
<meta name="citation_publication_date" content="2026-02-12">
<meta name="citation_cover_date" content="2026-02-12">
<meta name="citation_year" content="2026">
<meta name="citation_online_date" content="2026-02-12">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Towards best practice for specifying selectivity in age-structured integrated stock assessments;,citation_author=Kristin Privitera-Johnson;,citation_author=Richard D. Methot;,citation_author=André E. Punt;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_doi=10.1016/j.fishres.2022.106248;,citation_volume=248;,citation_journal_title=Fisheries Research;">
<meta name="citation_reference" content="citation_title=Model selection for selectivity in fisheries stock assessments;,citation_author=André E. Punt;,citation_author=Felipe Hurtado-Ferro;,citation_author=Athol R. Whitten;,citation_publication_date=2013;,citation_cover_date=2013;,citation_year=2013;,citation_doi=10.1016/j.fishres.2013.02.008;,citation_volume=141;,citation_journal_title=Fisheries Research;">
<meta name="citation_reference" content="citation_title=Confounding of gear selectivity and the natural mortality rate in cases where the former is a nonmonotone function of age;,citation_author=Grant G. Thompson;,citation_publication_date=1994;,citation_cover_date=1994;,citation_year=1994;,citation_issue=12;,citation_doi=10.1139/f94-265;,citation_volume=51;,citation_journal_title=Canadian Journal of Fisheries and Aquatic Sciences;">
<meta name="citation_reference" content="citation_title=Harvesting strategies and parameter estimation for an age-structured model;,citation_author=Richard B. Deriso;,citation_publication_date=1980;,citation_cover_date=1980;,citation_year=1980;,citation_doi=10.1139/f80-034;,citation_volume=37;,citation_journal_title=Canadian Journal of Fisheries and Aquatic Sciences;">
<meta name="citation_reference" content="citation_title=TMB: Automatic differentiation and Laplace approximation;,citation_author=Kasper Kristensen;,citation_author=Anders Nielsen;,citation_author=Casper W. Berg;,citation_author=Hans Skaug;,citation_author=Bradley M. Bell;,citation_publication_date=2016;,citation_cover_date=2016;,citation_year=2016;,citation_issue=5;,citation_doi=10.18637/jss.v070.i05;,citation_volume=70;,citation_journal_title=Journal of Statistical Software;">
<meta name="citation_reference" content="citation_title=Stock synthesis: A biological and statistical framework for fish stock assessment and fishery management;,citation_author=Richard D. Methot;,citation_author=Chantell R. Wetzel;,citation_publication_date=2013;,citation_cover_date=2013;,citation_year=2013;,citation_doi=10.1016/j.fishres.2012.10.012;,citation_volume=142;,citation_journal_title=Fisheries Research;">
<meta name="citation_reference" content="citation_title=Quantitative fish dynamics;,citation_author=Terrance J. Quinn;,citation_author=Richard B. Deriso;,citation_publication_date=1999;,citation_cover_date=1999;,citation_year=1999;">
</head>

<body class="quarto-light">

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Selectivity Options for Age-Structured Stock Assessments</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
            <p class="subtitle lead">A comparative framework using RTMB</p>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Author</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">James Ianelli </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        NOAA/NMFS Alaska Fisheries Science Center
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">February 12, 2026</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>

    <div>
      <div class="abstract">
        <div class="block-title">Abstract</div>
        <p>Selectivity is a fundamental component of age-structured stock assessment models, governing how fishing mortality and survey catchability vary with age or size. The choice of selectivity parameterization affects estimates of population abundance, fishing mortality, and management reference points. This manuscript compares several selectivity formulations—including standard logistic, double logistic, spline-based, and time-varying 2D autoregressive approaches—within a unified RTMB framework. We examine parameter identifiability, prior sensitivity, and the practical consequences of selectivity misspecification using simulation and application to eastern Bering Sea walleye pollock (<em>Gadus chalcogrammus</em>). Results highlight trade-offs between flexibility and estimability and provide guidance for practitioners choosing among selectivity options in operational assessments.</p>
      </div>
    </div>

    <div>
      <div class="keywords">
        <div class="block-title">Keywords</div>
        <p>selectivity, stock assessment, RTMB, fisheries, walleye pollock</p>
      </div>
    </div>

    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-intro" id="toc-sec-intro" class="nav-link active" data-scroll-target="#sec-intro"><span class="header-section-number">0.1</span> Introduction</a></li>
  <li><a href="#sec-logistic" id="toc-sec-logistic" class="nav-link" data-scroll-target="#sec-logistic"><span class="header-section-number">0.2</span> Standard Logistic Selectivity</a></li>
  <li><a href="#standard-logistic-selectivity" id="toc-standard-logistic-selectivity" class="nav-link" data-scroll-target="#standard-logistic-selectivity"><span class="header-section-number">1</span> Standard Logistic Selectivity</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">1.1</span> Overview</a></li>
  <li><a href="#model-definition" id="toc-model-definition" class="nav-link" data-scroll-target="#model-definition"><span class="header-section-number">1.2</span> Model definition</a></li>
  <li><a href="#scenario-exploration" id="toc-scenario-exploration" class="nav-link" data-scroll-target="#scenario-exploration"><span class="header-section-number">1.3</span> Scenario exploration</a></li>
  <li><a href="#rtmb-implementation" id="toc-rtmb-implementation" class="nav-link" data-scroll-target="#rtmb-implementation"><span class="header-section-number">1.4</span> RTMB implementation</a></li>
  </ul></li>
  <li><a href="#sec-double-logistic" id="toc-sec-double-logistic" class="nav-link" data-scroll-target="#sec-double-logistic"><span class="header-section-number">1.5</span> Double Logistic Selectivity</a></li>
  <li><a href="#double-logistic-selectivity-3-parameter-formulation" id="toc-double-logistic-selectivity-3-parameter-formulation" class="nav-link" data-scroll-target="#double-logistic-selectivity-3-parameter-formulation"><span class="header-section-number">2</span> Double Logistic Selectivity (3-parameter formulation)</a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1"><span class="header-section-number">2.1</span> Overview</a></li>
  <li><a href="#model-definition-1" id="toc-model-definition-1" class="nav-link" data-scroll-target="#model-definition-1"><span class="header-section-number">2.2</span> Model definition</a>
  <ul class="collapse">
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">2.2.1</span> Interpretation</a></li>
  </ul></li>
  <li><a href="#scenarios" id="toc-scenarios" class="nav-link" data-scroll-target="#scenarios"><span class="header-section-number">2.3</span> Scenarios</a></li>
  <li><a href="#faceted-scenario-curves" id="toc-faceted-scenario-curves" class="nav-link" data-scroll-target="#faceted-scenario-curves"><span class="header-section-number">2.4</span> Faceted scenario curves</a></li>
  <li><a href="#overlay-comparison" id="toc-overlay-comparison" class="nav-link" data-scroll-target="#overlay-comparison"><span class="header-section-number">2.5</span> Overlay comparison</a></li>
  <li><a href="#parameter-sensitivity-analysis" id="toc-parameter-sensitivity-analysis" class="nav-link" data-scroll-target="#parameter-sensitivity-analysis"><span class="header-section-number">2.6</span> Parameter sensitivity analysis</a></li>
  <li><a href="#rtmb-implementation-with-priors" id="toc-rtmb-implementation-with-priors" class="nav-link" data-scroll-target="#rtmb-implementation-with-priors"><span class="header-section-number">2.7</span> RTMB implementation with priors</a></li>
  <li><a href="#mcmc-evaluation" id="toc-mcmc-evaluation" class="nav-link" data-scroll-target="#mcmc-evaluation"><span class="header-section-number">2.8</span> MCMC evaluation</a>
  <ul class="collapse">
  <li><a href="#additional-prior-sets" id="toc-additional-prior-sets" class="nav-link" data-scroll-target="#additional-prior-sets"><span class="header-section-number">2.8.1</span> Additional prior sets</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-spline" id="toc-sec-spline" class="nav-link" data-scroll-target="#sec-spline"><span class="header-section-number">2.9</span> Spline-Based Selectivity</a></li>
  <li><a href="#spline-based-selectivity" id="toc-spline-based-selectivity" class="nav-link" data-scroll-target="#spline-based-selectivity"><span class="header-section-number">3</span> Spline-Based Selectivity</a>
  <ul class="collapse">
  <li><a href="#overview-2" id="toc-overview-2" class="nav-link" data-scroll-target="#overview-2"><span class="header-section-number">3.1</span> Overview</a></li>
  <li><a href="#model-definition-2" id="toc-model-definition-2" class="nav-link" data-scroll-target="#model-definition-2"><span class="header-section-number">3.2</span> Model definition</a></li>
  <li><a href="#basis-visualization" id="toc-basis-visualization" class="nav-link" data-scroll-target="#basis-visualization"><span class="header-section-number">3.3</span> Basis visualization</a></li>
  <li><a href="#example-curves" id="toc-example-curves" class="nav-link" data-scroll-target="#example-curves"><span class="header-section-number">3.4</span> Example curves</a></li>
  <li><a href="#rtmb-implementation-1" id="toc-rtmb-implementation-1" class="nav-link" data-scroll-target="#rtmb-implementation-1"><span class="header-section-number">3.5</span> RTMB implementation</a></li>
  </ul></li>
  <li><a href="#sec-timevarying" id="toc-sec-timevarying" class="nav-link" data-scroll-target="#sec-timevarying"><span class="header-section-number">3.6</span> Time-Varying Selectivity with 2D Autoregressive Structure</a></li>
  <li><a href="#time-varying-selectivity-with-2d-autoregressive-structure" id="toc-time-varying-selectivity-with-2d-autoregressive-structure" class="nav-link" data-scroll-target="#time-varying-selectivity-with-2d-autoregressive-structure"><span class="header-section-number">4</span> Time-Varying Selectivity with 2D Autoregressive Structure</a>
  <ul class="collapse">
  <li><a href="#overview-3" id="toc-overview-3" class="nav-link" data-scroll-target="#overview-3"><span class="header-section-number">4.1</span> Overview</a></li>
  <li><a href="#model-definition-3" id="toc-model-definition-3" class="nav-link" data-scroll-target="#model-definition-3"><span class="header-section-number">4.2</span> Model definition</a>
  <ul class="collapse">
  <li><a href="#selectivity-at-age-by-year" id="toc-selectivity-at-age-by-year" class="nav-link" data-scroll-target="#selectivity-at-age-by-year"><span class="header-section-number">4.2.1</span> Selectivity-at-age by year</a></li>
  <li><a href="#block-structure-for-change-years" id="toc-block-structure-for-change-years" class="nav-link" data-scroll-target="#block-structure-for-change-years"><span class="header-section-number">4.2.2</span> Block structure for change years</a></li>
  </ul></li>
  <li><a href="#separable-2d-ar1-prior" id="toc-separable-2d-ar1-prior" class="nav-link" data-scroll-target="#separable-2d-ar1-prior"><span class="header-section-number">4.3</span> Separable 2D AR1 prior</a>
  <ul class="collapse">
  <li><a href="#marginal-ar1-processes" id="toc-marginal-ar1-processes" class="nav-link" data-scroll-target="#marginal-ar1-processes"><span class="header-section-number">4.3.1</span> Marginal AR1 processes</a></li>
  <li><a href="#kronecker-product-structure" id="toc-kronecker-product-structure" class="nav-link" data-scroll-target="#kronecker-product-structure"><span class="header-section-number">4.3.2</span> Kronecker product structure</a></li>
  <li><a href="#marginal-scale" id="toc-marginal-scale" class="nav-link" data-scroll-target="#marginal-scale"><span class="header-section-number">4.3.3</span> Marginal scale</a></li>
  <li><a href="#log-density" id="toc-log-density" class="nav-link" data-scroll-target="#log-density"><span class="header-section-number">4.3.4</span> Log-density</a></li>
  </ul></li>
  <li><a href="#rtmb-implementation-2" id="toc-rtmb-implementation-2" class="nav-link" data-scroll-target="#rtmb-implementation-2"><span class="header-section-number">4.4</span> RTMB implementation</a>
  <ul class="collapse">
  <li><a href="#dseparable-mechanics" id="toc-dseparable-mechanics" class="nav-link" data-scroll-target="#dseparable-mechanics"><span class="header-section-number">4.4.1</span> <code>dseparable</code> mechanics</a></li>
  <li><a href="#selectivity-construction" id="toc-selectivity-construction" class="nav-link" data-scroll-target="#selectivity-construction"><span class="header-section-number">4.4.2</span> Selectivity construction</a></li>
  </ul></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="header-section-number">4.5</span> Visualization</a></li>
  <li><a href="#properties-and-considerations" id="toc-properties-and-considerations" class="nav-link" data-scroll-target="#properties-and-considerations"><span class="header-section-number">4.6</span> Properties and considerations</a></li>
  </ul></li>
  <li><a href="#sec-discussion" id="toc-sec-discussion" class="nav-link" data-scroll-target="#sec-discussion"><span class="header-section-number">4.7</span> Comparison and Discussion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="double_logistic_selectivity-preview.html"><i class="bi bi-journal-code"></i>Double Logistic Selectivity</a></li><li><a href="spline_selectivity-preview.html"><i class="bi bi-journal-code"></i>Spline-Based Selectivity</a></li><li><a href="logistic_selectivity-preview.html"><i class="bi bi-journal-code"></i>Standard Logistic Selectivity</a></li><li><a href="timevarying_selectivity-preview.html"><i class="bi bi-journal-code"></i>Time-Varying 2D AR1 Selectivity</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">



  


<section id="sec-intro" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="sec-intro"><span class="header-section-number">0.1</span> Introduction</h2>
<p>Selectivity functions describe the relative vulnerability of fish to capture as a function of age (or size) and are among the most influential—yet least observable—components of stock assessment models. The assumed shape of the selectivity curve directly affects estimates of spawning biomass, recruitment, and fishing mortality, and misspecification can propagate into biased reference points and management advice <span class="citation" data-cites="punt2013 thompson1994">(<a href="#ref-punt2013" role="doc-biblioref">Punt, Hurtado-Ferro, and Whitten 2013</a>; <a href="#ref-thompson1994" role="doc-biblioref">Thompson 1994</a>)</span>.</p>
<p>Despite its importance, selectivity is often treated as a modelling convenience rather than a biological or technological quantity to be estimated carefully. Most operational assessments adopt a logistic or double-logistic functional form, chosen for parsimony rather than fidelity to the underlying catch process. More flexible alternatives—such as penalized splines or non-parametric approaches—can reduce structural bias but may introduce identifiability problems, particularly when data are sparse or conflicting.</p>
<p>This manuscript develops a comparative framework for evaluating selectivity options within the R Template Model Builder (RTMB) environment. RTMB provides automatic differentiation, Laplace approximation for random effects, and integration with Bayesian sampling via SparseNUTS, making it a natural platform for exploring both maximum likelihood and posterior-based inference on selectivity parameters.</p>
<p>We organize the comparison around four selectivity families:</p>
<ol type="1">
<li><strong>Standard logistic</strong> (<a href="#sec-logistic" class="quarto-xref">Section&nbsp;0.2</a>): the two-parameter ascending logistic, widely used for fisheries where retention is assumed to be monotonically increasing with age.</li>
<li><strong>Double logistic</strong> (<a href="#sec-double-logistic" class="quarto-xref">Section&nbsp;1.5</a>): a dome-shaped three-parameter formulation allowing selectivity to decline at older ages, motivated by gear avoidance, ontogenetic habitat shifts, or differential availability.</li>
<li><strong>Spline-based</strong> (<a href="#sec-spline" class="quarto-xref">Section&nbsp;2.9</a>): a penalized B-spline approach offering flexible, data-driven selectivity shapes with smoothness controlled by a penalty parameter.</li>
<li><strong>Time-varying 2D AR1</strong> (<a href="#sec-timevarying" class="quarto-xref">Section&nbsp;3.6</a>): a separable autoregressive structure over year and age dimensions, allowing selectivity to evolve smoothly through time while maintaining age-specific coherence via a Kronecker-structured precision matrix.</li>
</ol>
<p>For each family, we present the mathematical formulation, an RTMB implementation with prior specification, parameter sensitivity analysis, and MCMC-based posterior evaluation. We then apply all to eastern Bering Sea walleye pollock data to illustrate practical trade-offs.</p>
</section>
<section id="sec-logistic" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="sec-logistic"><span class="header-section-number">0.2</span> Standard Logistic Selectivity</h2>
</section>
<section id="standard-logistic-selectivity" class="level1 quarto-embed-nb-cell" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Standard Logistic Selectivity</h1>
<p>Two-parameter ascending logistic formulation</p>
<section id="overview" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1.1</span> Overview</h2>
<p>The standard (ascending) logistic selectivity is the simplest and most commonly used parameterization in age-structured stock assessments. It assumes that selectivity increases monotonically with age and asymptotes at full selectivity.</p>
</section>
<section id="model-definition" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="model-definition"><span class="header-section-number">1.2</span> Model definition</h2>
<p>With parameters <span class="math inline">\(a_{50}\)</span> (age at 50% selectivity) and <span class="math inline">\(\delta\)</span> (slope width from 50% to 95% selectivity):</p>
<p><span class="math display">\[
\text{sel}(a) = \frac{1}{1 + \exp\left[-\log(19)\,\frac{a - a_{50}}{\delta}\right]}
\]</span></p>
<p>where <span class="math inline">\(\delta &gt; 0\)</span> controls how quickly selectivity transitions from low to high values.</p>
</section>
<section id="scenario-exploration" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="scenario-exploration"><span class="header-section-number">1.3</span> Scenario exploration</h2>
<div id="cell-fig-logistic-scenarios" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-logistic-scenarios" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-logistic-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/logistic_selectivity-fig-logistic-scenarios-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Standard logistic selectivity under different parameterizations."><img src="index_files/figure-html/logistic_selectivity-fig-logistic-scenarios-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-logistic-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Standard logistic selectivity under different parameterizations.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="rtmb-implementation" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="rtmb-implementation"><span class="header-section-number">1.4</span> RTMB implementation</h2>
<p><em>Placeholder: RTMB objective function with priors on <span class="math inline">\(a_{50}\)</span> and <span class="math inline">\(\delta\)</span>, optimization, and MCMC sampling.</em></p>
<div id="9b712e2a-5fc5-419c-9412-25f2bb6c49e1" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>library(RTMB)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function skeleton</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>f <span class="op">&lt;-</span> function(parms) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  getAll(data, parms, warn <span class="op">=</span> FALSE)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  a50 <span class="op">&lt;-</span> exp(log_a50)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  delta <span class="op">&lt;-</span> exp(log_delta)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  sel_hat <span class="op">&lt;-</span> logistic_sel(age, a50, delta)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  nll <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  nll <span class="op">&lt;-</span> nll <span class="op">-</span> dnorm(log_a50, mu_log_a50, sd_log_a50, log <span class="op">=</span> TRUE)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  nll <span class="op">&lt;-</span> nll <span class="op">-</span> dnorm(log_delta, mu_log_delta, sd_log_delta, log <span class="op">=</span> TRUE)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  ADREPORT(c(a50 <span class="op">=</span> a50, delta <span class="op">=</span> delta))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  nll</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<!-- -->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Standard Logistic Selectivity"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Two-parameter ascending logistic formulation"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>The standard (ascending) logistic selectivity is the simplest and most commonly</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>used parameterization in age-structured stock assessments. It assumes that</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>selectivity increases monotonically with age and asymptotes at full selectivity.</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model definition</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>With parameters $a_{50}$ (age at 50% selectivity) and $\delta$ (slope width from</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>50% to 95% selectivity):</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>\text{sel}(a) = \frac{1}{1 + \exp\left<span class="co">[</span><span class="ot">-\log(19)\,\frac{a - a_{50}}{\delta}\right</span><span class="co">]</span>}</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>where $\delta &gt; 0$ controls how quickly selectivity transitions from low to high</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>values.</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>logistic_sel <span class="ot">&lt;-</span> <span class="cf">function</span>(age, a50, delta) {</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>) <span class="sc">*</span> (age <span class="sc">-</span> a50) <span class="sc">/</span> delta))</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scenario exploration</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{r scenarios}</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-logistic-scenarios</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Standard logistic selectivity under different parameterizations."</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">a50 =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.5</span>, <span class="fl">3.0</span>),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> ages</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">selectivity =</span> <span class="fu">logistic_sel</span>(age, a50, delta),</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"a50 = %g, delta = %g"</span>, a50, delta)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scenarios, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> <span class="fu">factor</span>(delta))) <span class="sc">+</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="fu">paste</span>(<span class="st">"a50 ="</span>, a50)) <span class="sc">+</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"delta"</span>) <span class="sc">+</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>)) <span class="sc">+</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity"</span>) <span class="sc">+</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## RTMB implementation</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>*Placeholder: RTMB objective function with priors on $a_{50}$ and $\delta$,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>optimization, and MCMC sampling.*</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rtmb-placeholder}</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RTMB)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function skeleton</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(parms) {</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span>(data, parms, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>  a50 <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_a50)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_delta)</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  sel_hat <span class="ot">&lt;-</span> <span class="fu">logistic_sel</span>(age, a50, delta)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> nll <span class="sc">-</span> <span class="fu">dnorm</span>(log_a50, mu_log_a50, sd_log_a50, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> nll <span class="sc">-</span> <span class="fu">dnorm</span>(log_delta, mu_log_delta, sd_log_delta, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ADREPORT</span>(<span class="fu">c</span>(<span class="at">a50 =</span> a50, <span class="at">delta =</span> delta))</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  nll</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="sec-double-logistic" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="sec-double-logistic"><span class="header-section-number">1.5</span> Double Logistic Selectivity</h2>
</section>
<section id="double-logistic-selectivity-3-parameter-formulation" class="level1 quarto-embed-nb-cell" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Double Logistic Selectivity (3-parameter formulation)</h1>
<p>Parameterization, sensitivity, and prior elicitation via RTMB</p>
<section id="overview-1" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="overview-1"><span class="header-section-number">2.1</span> Overview</h2>
<p>This notebook documents the 3-parameter double logistic selectivity curve used for prior elicitation in the EBS pollock assessment workflow. The formulation allows dome-shaped selectivity, where vulnerability increases with age to a peak and then declines. This behavior is motivated by gear avoidance at older ages, ontogenetic habitat shifts, or differential availability between age classes.</p>
</section>
<section id="model-definition-1" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="model-definition-1"><span class="header-section-number">2.2</span> Model definition</h2>
<p>Let age be <span class="math inline">\(a\)</span>, with parameters <span class="math inline">\(p_1\)</span>, <span class="math inline">\(p_2\)</span>, and <span class="math inline">\(p_3\)</span> and derived inflection points <span class="math inline">\(\gamma_1\)</span> and <span class="math inline">\(\gamma_2\)</span>:</p>
<p><span class="math display">\[
\gamma_1 = p_1 + p_2, \qquad
\gamma_2 = 2p_1 + p_2 + p_3.
\]</span></p>
<p>The ascending limb is a standard logistic and the descending limb is one minus a logistic:</p>
<p><span class="math display">\[
\text{asc}(a) = \frac{1}{1 + \exp\left[-\log(19)\,\frac{a - \gamma_1}{p_1}\right]},
\]</span></p>
<p><span class="math display">\[
\text{desc}(a) = 1 - \frac{1}{1 + \exp\left[-\log(19)\,\frac{a - \gamma_2}{p_3}\right]}.
\]</span></p>
<p>The full double logistic selectivity is</p>
<p><span class="math display">\[
\text{sel}(a) = \min\left(1,\ \frac{\text{asc}(a)\,\text{desc}(a)}{0.95^2}\right).
\]</span></p>
<section id="interpretation" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="interpretation"><span class="header-section-number">2.2.1</span> Interpretation</h3>
<ul>
<li><span class="math inline">\(p_1 &gt; 0\)</span> controls the ascending slope and is the distance from <span class="math inline">\(\gamma_1\)</span> (50% selectivity) to the 95% point.</li>
<li><span class="math inline">\(p_2\)</span> shifts the ascending limb through <span class="math inline">\(\gamma_1 = p_1 + p_2\)</span>.</li>
<li><span class="math inline">\(p_3 &gt; 0\)</span> controls the descending slope and is the distance from <span class="math inline">\(\gamma_2\)</span> (50% on the descending limb) to the 5% point.</li>
<li>The dome width is <span class="math inline">\(\gamma_2 - \gamma_1 = p_1 + p_3\)</span>.</li>
<li>The factor <span class="math inline">\(0.95^{-2}\)</span> normalizes the curve so that when both limbs are at 0.95 the product is near 1 (then capped at 1.0).</li>
</ul>
</section>
</section>
<section id="scenarios" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="scenarios"><span class="header-section-number">2.3</span> Scenarios</h2>
<div class="cell">
<div id="tbl-dl-scenarios" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dl-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Scenario parameters and derived inflection points
</figcaption>
<div aria-describedby="tbl-dl-scenarios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 41%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">scenario</th>
<th style="text-align: right;">p1</th>
<th style="text-align: right;">p2</th>
<th style="text-align: right;">p3</th>
<th style="text-align: right;">gamma1</th>
<th style="text-align: right;">gamma2</th>
<th style="text-align: right;">dome_width</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Wide dome</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2.5</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">10.5</td>
<td style="text-align: right;">4.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Asymmetric</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">(fast rise, slow decline)</td>
<td style="text-align: right;">0.8</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">3.0</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">8.6</td>
<td style="text-align: right;">3.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Asymmetric</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">(slow rise, fast decline)</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.8</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">7.8</td>
<td style="text-align: right;">2.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nearly asymptotic</td>
<td style="text-align: right;">1.5</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">5.5</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">9.5</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The scenario summary in <a href="#tbl-dl-scenarios" class="quarto-xref">Table&nbsp;1</a> lists the four parameter sets and the derived inflection points (<span class="math inline">\(\gamma_1\)</span>, <span class="math inline">\(\gamma_2\)</span>) used in the selectivity scenarios.</p>
</section>
<section id="faceted-scenario-curves" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="faceted-scenario-curves"><span class="header-section-number">2.4</span> Faceted scenario curves</h2>
<p>Each scenario appears on its own panel in <a href="#fig-dl-faceted" class="quarto-xref">Figure&nbsp;2</a> so the ascent, descent, and dome width can be compared against the 50% and 95% reference lines.</p>
<div id="cell-fig-dl-faceted" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-faceted" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-faceted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-faceted-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Double logistic selectivity for each parameter scenario."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-faceted-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-faceted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Double logistic selectivity for each parameter scenario.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="overlay-comparison" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="overlay-comparison"><span class="header-section-number">2.5</span> Overlay comparison</h2>
<p>All scenarios are overlaid in <a href="#fig-dl-overlay" class="quarto-xref">Figure&nbsp;3</a> to highlight differences in peak age and decline shape when the curves are viewed on a common axis.</p>
<div id="cell-fig-dl-overlay" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-overlay" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-overlay-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-overlay-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: All scenarios overlaid for direct comparison."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-overlay-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-overlay-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: All scenarios overlaid for direct comparison.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="parameter-sensitivity-analysis" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="parameter-sensitivity-analysis"><span class="header-section-number">2.6</span> Parameter sensitivity analysis</h2>
<p>The three panels in <a href="#fig-dl-sensitivity" class="quarto-xref">Figure&nbsp;4</a> show how each parameter changes the curve when the other two are held fixed.</p>
<div id="cell-fig-dl-sensitivity" class="cell" data-fig-width="8" data-fig-height="8">
<div class="cell-output cell-output-display">
<div id="fig-dl-sensitivity" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-sensitivity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-sensitivity-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Sensitivity to p1, p2, and p3 with other parameters fixed."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-sensitivity-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-sensitivity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Sensitivity to p1, p2, and p3 with other parameters fixed.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="rtmb-implementation-with-priors" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="rtmb-implementation-with-priors"><span class="header-section-number">2.7</span> RTMB implementation with priors</h2>
<p>A common approach is to estimate on the log scale for the positive parameters and apply lognormal priors on <span class="math inline">\(p_1\)</span> and <span class="math inline">\(p_3\)</span>:</p>
<p><span class="math display">\[
\log(p_k) \sim \mathcal{N}(\mu_k, \sigma_k^2), \qquad k \in \{1, 3\}.
\]</span></p>
<p>If using a lognormal prior specified by median <span class="math inline">\(m\)</span> and coefficient of variation <span class="math inline">\(\text{CV}\)</span> on the natural scale, a convenient conversion is</p>
<p><span class="math display">\[
\mu = \log(m), \qquad \sigma = \sqrt{\log(\text{CV}^2 + 1)}.
\]</span></p>
<p>Parameter <span class="math inline">\(p_2\)</span> can remain unconstrained (normal prior) or be modeled on the log scale if you want to enforce <span class="math inline">\(p_2 &gt; 0\)</span>.</p>
<div id="c9858b2e-8ceb-4665-b1cf-4ca0b85165a2" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>library(RTMB)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dbl_logistic_sel <span class="op">&lt;-</span> function(age, p1, p2, p3) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  gamma1 <span class="op">&lt;-</span> p1 <span class="op">+</span> p2</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  gamma2 <span class="op">&lt;-</span> <span class="dv">2</span> <span class="op">*</span> p1 <span class="op">+</span> p2 <span class="op">+</span> p3</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  asc <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> exp(<span class="op">-</span>log(<span class="dv">19</span>) <span class="op">*</span> (age <span class="op">-</span> gamma1) <span class="op">/</span> p1))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  desc <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> exp(<span class="op">-</span>log(<span class="dv">19</span>) <span class="op">*</span> (age <span class="op">-</span> gamma2) <span class="op">/</span> p3))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  (asc <span class="op">*</span> desc <span class="op">*</span> <span class="fl">0.95</span><span class="op">^</span>(<span class="op">-</span><span class="dv">2</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>lognorm_from_median_cv <span class="op">&lt;-</span> function(median, cv) {</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  sigma <span class="op">&lt;-</span> sqrt(log(cv<span class="op">^</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="op">&lt;-</span> log(median)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">list</span>(mu <span class="op">=</span> mu, sigma <span class="op">=</span> sigma)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>age <span class="op">&lt;-</span> seq(<span class="dv">1</span>, <span class="dv">15</span>, by <span class="op">=</span> <span class="fl">0.25</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>sel_obs <span class="op">&lt;-</span> c(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.037142857</span>, <span class="fl">0.064285714</span>, <span class="fl">0.091428571</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.118571429</span>, <span class="fl">0.145714286</span>, <span class="fl">0.172857143</span>, <span class="fl">0.2</span>, <span class="fl">0.205882353</span>, <span class="fl">0.211764706</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.217647059</span>, <span class="fl">0.223529412</span>, <span class="fl">0.229411765</span>, <span class="fl">0.235294118</span>, <span class="fl">0.241176471</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.247058824</span>, <span class="fl">0.252941176</span>, <span class="fl">0.258823529</span>, <span class="fl">0.264705882</span>, <span class="fl">0.270588235</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.276470588</span>, <span class="fl">0.282352941</span>, <span class="fl">0.288235294</span>, <span class="fl">0.294117647</span>, <span class="fl">0.3</span>, <span class="fl">0.31</span>, <span class="fl">0.32</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.33</span>, <span class="fl">0.34</span>, <span class="fl">0.35</span>, <span class="fl">0.36</span>, <span class="fl">0.37</span>, <span class="fl">0.38</span>, <span class="fl">0.39</span>, <span class="fl">0.4</span>, <span class="fl">0.41</span>, <span class="fl">0.42</span>, <span class="fl">0.43</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.44</span>, <span class="fl">0.45</span>, <span class="fl">0.46</span>, <span class="fl">0.47</span>, <span class="fl">0.48</span>, <span class="fl">0.49</span>, <span class="fl">0.5</span>, <span class="fl">0.5125</span>, <span class="fl">0.525</span>, <span class="fl">0.5375</span>, <span class="fl">0.55</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5625</span>, <span class="fl">0.575</span>, <span class="fl">0.5875</span>, <span class="fl">0.6</span>, <span class="fl">0.6125</span>, <span class="fl">0.625</span>, <span class="fl">0.6375</span>, <span class="fl">0.65</span>, <span class="fl">0.6625</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.675</span>, <span class="fl">0.6875</span>, <span class="fl">0.7</span>, <span class="fl">0.7125</span>, <span class="fl">0.725</span>, <span class="fl">0.7375</span>, <span class="fl">0.75</span>, <span class="fl">0.7625</span>, <span class="fl">0.775</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.7875</span>, <span class="fl">0.8</span>, <span class="fl">0.807894737</span>, <span class="fl">0.815789474</span>, <span class="fl">0.823684211</span>, <span class="fl">0.831578947</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.839473684</span>, <span class="fl">0.847368421</span>, <span class="fl">0.855263158</span>, <span class="fl">0.863157895</span>, <span class="fl">0.871052632</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.878947368</span>, <span class="fl">0.886842105</span>, <span class="fl">0.894736842</span>, <span class="fl">0.902631579</span>, <span class="fl">0.910526316</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.918421053</span>, <span class="fl">0.926315789</span>, <span class="fl">0.934210526</span>, <span class="fl">0.942105263</span>, <span class="fl">0.95</span>, <span class="fl">0.954545455</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.959090909</span>, <span class="fl">0.963636364</span>, <span class="fl">0.968181818</span>, <span class="fl">0.972727273</span>, <span class="fl">0.977272727</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.981818182</span>, <span class="fl">0.986363636</span>, <span class="fl">0.990909091</span>, <span class="fl">0.995454545</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="fl">0.989285714</span>, <span class="fl">0.978571429</span>, <span class="fl">0.967857143</span>, <span class="fl">0.957142857</span>, <span class="fl">0.946428571</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.935714286</span>, <span class="fl">0.925</span>, <span class="fl">0.914285714</span>, <span class="fl">0.903571429</span>, <span class="fl">0.892857143</span>, <span class="fl">0.882142857</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.871428571</span>, <span class="fl">0.860714286</span>, <span class="fl">0.85</span>, <span class="fl">0.839285714</span>, <span class="fl">0.828571429</span>, <span class="fl">0.817857143</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.807142857</span>, <span class="fl">0.796428571</span>, <span class="fl">0.785714286</span>, <span class="fl">0.775</span>, <span class="fl">0.764285714</span>, <span class="fl">0.753571429</span>,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.742857143</span>, <span class="fl">0.732142857</span>, <span class="fl">0.721428571</span>, <span class="fl">0.710714286</span>, <span class="fl">0.7</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>sel_sd <span class="op">&lt;-</span> rep(<span class="fl">0.05</span>, length(age))</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>p1_prior <span class="op">&lt;-</span> lognorm_from_median_cv(median <span class="op">=</span> <span class="fl">1.5</span>, cv <span class="op">=</span> <span class="fl">0.4</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>p3_prior <span class="op">&lt;-</span> lognorm_from_median_cv(median <span class="op">=</span> <span class="fl">2.5</span>, cv <span class="op">=</span> <span class="fl">0.6</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>p2_prior <span class="op">&lt;-</span> <span class="bu">list</span>(mu <span class="op">=</span> <span class="dv">4</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>make_prior_data <span class="op">&lt;-</span> function(p1_prior, p2_prior, p3_prior) {</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="bu">list</span>(</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> age,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    sel_obs <span class="op">=</span> sel_obs,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    sel_sd <span class="op">=</span> sel_sd,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    mu_log_p1 <span class="op">=</span> p1_prior$mu,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    sd_log_p1 <span class="op">=</span> p1_prior$sigma,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    mu_p2 <span class="op">=</span> p2_prior$mu,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    sd_p2 <span class="op">=</span> p2_prior$sigma,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    mu_log_p3 <span class="op">=</span> p3_prior$mu,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    sd_log_p3 <span class="op">=</span> p3_prior$sigma</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>data <span class="op">&lt;-</span> make_prior_data(p1_prior, p2_prior, p3_prior)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">&lt;-</span> <span class="bu">list</span>(</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  log_p1 <span class="op">=</span> log(<span class="fl">1.5</span>),</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  p2 <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  log_p3 <span class="op">=</span> log(<span class="fl">2.5</span>)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>make_obj <span class="op">&lt;-</span> function(data, parameters) {</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  f <span class="op">&lt;-</span> function(parms) {</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    getAll(data, parms, warn <span class="op">=</span> FALSE)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    p1 <span class="op">&lt;-</span> exp(log_p1)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    p3 <span class="op">&lt;-</span> exp(log_p3)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    sel_hat <span class="op">&lt;-</span> dbl_logistic_sel(age, p1, p2, p3)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    nll <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    nll <span class="op">&lt;-</span> nll <span class="op">-</span> dnorm(log_p1, mu_log_p1, sd_log_p1, log <span class="op">=</span> TRUE)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    nll <span class="op">&lt;-</span> nll <span class="op">-</span> dnorm(p2, mu_p2, sd_p2, log <span class="op">=</span> TRUE)</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    nll <span class="op">&lt;-</span> nll <span class="op">-</span> dnorm(log_p3, mu_log_p3, sd_log_p3, log <span class="op">=</span> TRUE)</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    ADREPORT(c(p1 <span class="op">=</span> p1, p2 <span class="op">=</span> p2, p3 <span class="op">=</span> p3))</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    nll</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>  MakeADFun(f, parameters)</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>obj <span class="op">&lt;-</span> make_obj(data, parameters)</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>opt <span class="op">&lt;-</span> nlminb(obj$par, obj$fn, obj$gr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>outer mgc:  0 outer mgc:  0 
outer mgc:  0.006737636 
outer mgc:  0.006737636 
outer mgc:  0.001 
outer mgc:  0.001 
outer mgc:  0.003252194 
outer mgc:  0.003252194 
outer mgc:  2.5 </code></pre>
</div>
</div>
</section>
<section id="mcmc-evaluation" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="mcmc-evaluation"><span class="header-section-number">2.8</span> MCMC evaluation</h2>
<div id="c89aab12-fece-420f-905f-f1e1bac6f4be" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>library(SparseNUTS)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>

Gradient evaluation took 3.4e-05 seconds
1000 transitions using 10 leapfrog steps per transition would take 0.34 seconds.
Adjust your expectations accordingly!



 Elapsed Time: 0.018 seconds (Warm-up)
               0.197 seconds (Sampling)
               0.215 seconds (Total)



Model 'selectivity_set1' has 3 pars, and was fit using NUTS with a 'diag' metric
1 chain(s) of 1300 total iterations (150 warmup) were used
Average run time per chain was 0.22 seconds 
Minimum ESS=360.7 (31.37%), and maximum Rhat=1.015
There were 0 divergences after warmup</code></pre>
</div>
</div>
<div id="cell-fig-dl-marginals" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-marginals" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-marginals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-marginals-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Marginal posterior distributions for selectivity parameters (SparseNUTS, prior set 1)."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-marginals-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-marginals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Marginal posterior distributions for selectivity parameters (SparseNUTS, prior set 1).
</figcaption>
</figure>
</div>
</div>
</div>
<p>The marginal posterior densities in <a href="#fig-dl-marginals" class="quarto-xref">Figure&nbsp;5</a> summarize <span class="math inline">\((p_1, p_2,
p_3)\)</span> under prior set 1.</p>
<div id="cell-fig-dl-pairs" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-pairs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-pairs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-pairs-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: Pairwise posterior scatterplots for selectivity parameters."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-pairs-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-pairs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Pairwise posterior scatterplots for selectivity parameters.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-dl-mcmc-set1" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-mcmc-set1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-mcmc-set1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set1-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: MCMC selectivity draws for prior set 1 (p1 median 1.5, p3 median 2.5, p2 sd 1)."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set1-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-mcmc-set1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: MCMC selectivity draws for prior set 1 (p1 median 1.5, p3 median 2.5, p2 sd 1).
</figcaption>
</figure>
</div>
</div>
</div>
<section id="additional-prior-sets" class="level3" data-number="2.8.1">
<h3 data-number="2.8.1" class="anchored" data-anchor-id="additional-prior-sets"><span class="header-section-number">2.8.1</span> Additional prior sets</h3>
<div id="38deb83b-3b69-4a31-8e6a-3a3c32819246" class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>

Gradient evaluation took 2.8e-05 seconds
1000 transitions using 10 leapfrog steps per transition would take 0.28 seconds.
Adjust your expectations accordingly!



 Elapsed Time: 0.018 seconds (Warm-up)
               0.116 seconds (Sampling)
               0.134 seconds (Total)



Model 'selectivity_set2' has 3 pars, and was fit using NUTS with a 'diag' metric
1 chain(s) of 1300 total iterations (150 warmup) were used
Average run time per chain was 0.13 seconds 
Minimum ESS=393.8 (34.24%), and maximum Rhat=1.003
There were 0 divergences after warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

Gradient evaluation took 2.2e-05 seconds
1000 transitions using 10 leapfrog steps per transition would take 0.22 seconds.
Adjust your expectations accordingly!



 Elapsed Time: 0.017 seconds (Warm-up)
               0.121 seconds (Sampling)
               0.138 seconds (Total)



Model 'selectivity_set3' has 3 pars, and was fit using NUTS with a 'diag' metric
1 chain(s) of 1300 total iterations (150 warmup) were used
Average run time per chain was 0.14 seconds 
Minimum ESS=427 (37.13%), and maximum Rhat=1.005
There were 0 divergences after warmup</code></pre>
</div>
</div>
<div id="cell-fig-dl-mcmc-set2" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-mcmc-set2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-mcmc-set2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set2-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: MCMC selectivity draws for prior set 2 (p1 median 1.5, p3 median 8, p2 sd 1)."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set2-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-mcmc-set2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: MCMC selectivity draws for prior set 2 (p1 median 1.5, p3 median 8, p2 sd 1).
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-dl-mcmc-set3" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-dl-mcmc-set3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dl-mcmc-set3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set3-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;9: MCMC selectivity draws for prior set 3 (p1 median 1.5, p3 median 8, p2 sd 2)."><img src="index_files/figure-html/double_logistic_selectivity-fig-dl-mcmc-set3-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dl-mcmc-set3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: MCMC selectivity draws for prior set 3 (p1 median 1.5, p3 median 8, p2 sd 2).
</figcaption>
</figure>
</div>
</div>
</div>
<!-- -->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Double Logistic Selectivity (3-parameter formulation)"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Parameterization, sensitivity, and prior elicitation via RTMB"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>This notebook documents the 3-parameter double logistic selectivity curve used</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>for prior elicitation in the EBS pollock assessment workflow. The formulation</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>allows dome-shaped selectivity, where vulnerability increases with age to a peak</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>and then declines. This behavior is motivated by gear avoidance at older ages,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ontogenetic habitat shifts, or differential availability between age classes.</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model definition</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>Let age be $a$, with parameters $p_1$, $p_2$, and $p_3$ and derived inflection</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>points $\gamma_1$ and $\gamma_2$:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>\gamma_1 = p_1 + p_2, \qquad</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>\gamma_2 = 2p_1 + p_2 + p_3.</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>The ascending limb is a standard logistic and the descending limb is</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>one minus a logistic:</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>\text{asc}(a) = \frac{1}{1 + \exp\left<span class="co">[</span><span class="ot">-\log(19)\,\frac{a - \gamma_1}{p_1}\right</span><span class="co">]</span>},</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>\text{desc}(a) = 1 - \frac{1}{1 + \exp\left<span class="co">[</span><span class="ot">-\log(19)\,\frac{a - \gamma_2}{p_3}\right</span><span class="co">]</span>}.</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>The full double logistic selectivity is</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>\text{sel}(a) = \min\left(1,\ \frac{\text{asc}(a)\,\text{desc}(a)}{0.95^2}\right).</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p_1 &gt; 0$ controls the ascending slope and is the distance from</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  $\gamma_1$ (50% selectivity) to the 95% point.</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p_2$ shifts the ascending limb through $\gamma_1 = p_1 + p_2$.</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p_3 &gt; 0$ controls the descending slope and is the distance from</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>  $\gamma_2$ (50% on the descending limb) to the 5% point.</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The dome width is $\gamma_2 - \gamma_1 = p_1 + p_3$.</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The factor $0.95^{-2}$ normalizes the curve so that when both limbs are at</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  0.95 the product is near 1 (then capped at 1.0).</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scenarios</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>dbl_logistic_sel <span class="ot">&lt;-</span> <span class="cf">function</span>(age, p1, p2, p3) {</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  gamma1 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> p2</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  gamma2 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>  asc <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>) <span class="sc">*</span> (age <span class="sc">-</span> gamma1) <span class="sc">/</span> p1))</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>  desc <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>) <span class="sc">*</span> (age <span class="sc">-</span> gamma2) <span class="sc">/</span> p3))</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> asc <span class="sc">*</span> desc <span class="sc">*</span> <span class="fl">0.95</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">2</span>)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmin</span>(sel, <span class="fl">1.0</span>)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">scenario =</span> <span class="fu">c</span>(</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Wide dome"</span>,</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Asymmetric</span><span class="sc">\n</span><span class="st">(fast rise, slow decline)"</span>,</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Asymmetric</span><span class="sc">\n</span><span class="st">(slow rise, fast decline)"</span>,</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nearly asymptotic"</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">0.8</span>, <span class="fl">2.0</span>, <span class="fl">1.5</span>),</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="fu">c</span>(<span class="fl">4.0</span>, <span class="fl">4.0</span>, <span class="fl">3.0</span>, <span class="fl">4.0</span>),</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">3.0</span>, <span class="fl">0.8</span>, <span class="fl">8.0</span>)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma1 =</span> p1 <span class="sc">+</span> p2,</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma2 =</span> <span class="dv">2</span> <span class="sc">*</span> p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3,</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">dome_width =</span> gamma2 <span class="sc">-</span> gamma1</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>sel_data <span class="ot">&lt;-</span> scenarios <span class="sc">%&gt;%</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>({</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    scen <span class="ot">&lt;-</span> .</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario =</span> scen<span class="sc">$</span>scenario,</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> ages,</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">selectivity =</span> <span class="fu">dbl_logistic_sel</span>(ages, scen<span class="sc">$</span>p1, scen<span class="sc">$</span>p2, scen<span class="sc">$</span>p3),</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">p1 =</span> scen<span class="sc">$</span>p1,</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">p2 =</span> scen<span class="sc">$</span>p2,</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">p3 =</span> scen<span class="sc">$</span>p3,</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">gamma1 =</span> scen<span class="sc">$</span>gamma1,</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">gamma2 =</span> scen<span class="sc">$</span>gamma2</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%s</span><span class="sc">\n</span><span class="st">(p1=%.1f, p2=%.1f, p3=%.1f)"</span>, scenario, p1, p2, p3)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r scenario-table}</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-dl-scenarios</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Scenario parameters and derived inflection points"</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>  scenarios,</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>The scenario summary in @tbl-dl-scenarios lists the four parameter sets and the</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>derived inflection points ($\gamma_1$, $\gamma_2$) used in the selectivity</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>scenarios.</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a><span class="fu">## Faceted scenario curves</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>Each scenario appears on its own panel in @fig-dl-faceted so the ascent,</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>descent, and dome width can be compared against the 50% and 95% reference</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>lines.</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-faceted}</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-faceted</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Double logistic selectivity for each parameter scenario."</span></span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>p1_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sel_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity)) <span class="sc">+</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> gamma1), <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> gamma2), <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>label, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">14</span>, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"3-parameter double logistic selectivity curves"</span>,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed lines show 50% and 95% selectivity"</span>,</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Selectivity"</span>,</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red dotted = gamma1, orange dotted = gamma2"</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>p1_plot</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overlay comparison</span></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>All scenarios are overlaid in @fig-dl-overlay to highlight differences in peak</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>age and decline shape when the curves are viewed on a common axis.</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-overlay}</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-overlay</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "All scenarios overlaid for direct comparison."</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>p2_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sel_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> scenario)) <span class="sc">+</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">14</span>, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">name =</span> <span class="st">"Scenario"</span>) <span class="sc">+</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of double logistic selectivity curves"</span>,</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"All scenarios overlaid"</span>,</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Selectivity"</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>p2_plot</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter sensitivity analysis</span></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>The three panels in @fig-dl-sensitivity show how each parameter changes the</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>curve when the other two are held fixed.</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-sensitivity}</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-sensitivity</span></span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Sensitivity to p1, p2, and p3 with other parameters fixed."</span></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>p1_vary <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="dv">3</span>, <span class="at">by =</span> <span class="fl">0.5</span>),</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="dv">5</span>,</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="dv">2</span>,</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> ages</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selectivity =</span> <span class="fu">dbl_logistic_sel</span>(age, p1, p2, p3)) <span class="sc">%&gt;%</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>p3a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(p1_vary, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> <span class="fu">factor</span>(p1))) <span class="sc">+</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"p1"</span>, <span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>)) <span class="sc">+</span></span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sensitivity to p1 (ascending slope)"</span>,</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"p2 = 5, p3 = 2 fixed"</span>,</span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity"</span>) <span class="sc">+</span></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>, <span class="at">aspect.ratio =</span> <span class="dv">1</span>)</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>p2_vary <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="fl">1.5</span>,</span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="dv">2</span>,</span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> ages</span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selectivity =</span> <span class="fu">dbl_logistic_sel</span>(age, p1, p2, p3)) <span class="sc">%&gt;%</span></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>p3b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(p2_vary, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> <span class="fu">factor</span>(p2))) <span class="sc">+</span></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"p2"</span>, <span class="at">option =</span> <span class="st">"D"</span>) <span class="sc">+</span></span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>)) <span class="sc">+</span></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sensitivity to p2 (horizontal shift)"</span>,</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"p1 = 1.5, p3 = 2 fixed"</span>,</span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity"</span>) <span class="sc">+</span></span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>, <span class="at">aspect.ratio =</span> <span class="dv">1</span>)</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>p3_vary <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1 =</span> <span class="fl">1.5</span>,</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="dv">4</span>,</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>  <span class="at">p3 =</span> <span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="fl">6.5</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> ages</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">selectivity =</span> <span class="fu">dbl_logistic_sel</span>(age, p1, p2, p3)) <span class="sc">%&gt;%</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>p3c <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(p3_vary, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> <span class="fu">factor</span>(p3))) <span class="sc">+</span></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"p3"</span>, <span class="at">option =</span> <span class="st">"E"</span>) <span class="sc">+</span></span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>)) <span class="sc">+</span></span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sensitivity to p3 (descending slope)"</span>,</span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"p1 = 1.5, p2 = 4 fixed"</span>,</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity"</span>) <span class="sc">+</span></span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>, <span class="at">aspect.ratio =</span> <span class="dv">1</span>)</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>p_sensitivity <span class="ot">&lt;-</span> (p3a <span class="sc">|</span> p3b) <span class="sc">/</span> (p3c <span class="sc">|</span> <span class="fu">plot_spacer</span>()) <span class="sc">+</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Parameter sensitivity analysis"</span>,</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Effect of varying each parameter individually"</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>p_sensitivity</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## RTMB implementation with priors</span></span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>A common approach is to estimate on the log scale for the positive parameters</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a>and apply lognormal priors on $p_1$ and $p_3$:</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>\log(p_k) \sim \mathcal{N}(\mu_k, \sigma_k^2), \qquad k \in <span class="sc">\{</span>1, 3<span class="sc">\}</span>.</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>If using a lognormal prior specified by median $m$ and coefficient of variation</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>$\text{CV}$ on the natural scale, a convenient conversion is</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a>\mu = \log(m), \qquad \sigma = \sqrt{\log(\text{CV}^2 + 1)}.</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>Parameter $p_2$ can remain unconstrained (normal prior) or be modeled on the log</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>scale if you want to enforce $p_2 &gt; 0$.</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rtmb-draft}</span></span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RTMB)</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>dbl_logistic_sel <span class="ot">&lt;-</span> <span class="cf">function</span>(age, p1, p2, p3) {</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>  gamma1 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> p2</span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>  gamma2 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>  asc <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>) <span class="sc">*</span> (age <span class="sc">-</span> gamma1) <span class="sc">/</span> p1))</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>  desc <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>) <span class="sc">*</span> (age <span class="sc">-</span> gamma2) <span class="sc">/</span> p3))</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>  (asc <span class="sc">*</span> desc <span class="sc">*</span> <span class="fl">0.95</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">2</span>))</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>lognorm_from_median_cv <span class="ot">&lt;-</span> <span class="cf">function</span>(median, cv) {</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">log</span>(cv<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">log</span>(median)</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">mu =</span> mu, <span class="at">sigma =</span> sigma)</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.25</span>)</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>sel_obs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.037142857</span>, <span class="fl">0.064285714</span>, <span class="fl">0.091428571</span>,</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.118571429</span>, <span class="fl">0.145714286</span>, <span class="fl">0.172857143</span>, <span class="fl">0.2</span>, <span class="fl">0.205882353</span>, <span class="fl">0.211764706</span>,</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.217647059</span>, <span class="fl">0.223529412</span>, <span class="fl">0.229411765</span>, <span class="fl">0.235294118</span>, <span class="fl">0.241176471</span>,</span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.247058824</span>, <span class="fl">0.252941176</span>, <span class="fl">0.258823529</span>, <span class="fl">0.264705882</span>, <span class="fl">0.270588235</span>,</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.276470588</span>, <span class="fl">0.282352941</span>, <span class="fl">0.288235294</span>, <span class="fl">0.294117647</span>, <span class="fl">0.3</span>, <span class="fl">0.31</span>, <span class="fl">0.32</span>,</span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.33</span>, <span class="fl">0.34</span>, <span class="fl">0.35</span>, <span class="fl">0.36</span>, <span class="fl">0.37</span>, <span class="fl">0.38</span>, <span class="fl">0.39</span>, <span class="fl">0.4</span>, <span class="fl">0.41</span>, <span class="fl">0.42</span>, <span class="fl">0.43</span>,</span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.44</span>, <span class="fl">0.45</span>, <span class="fl">0.46</span>, <span class="fl">0.47</span>, <span class="fl">0.48</span>, <span class="fl">0.49</span>, <span class="fl">0.5</span>, <span class="fl">0.5125</span>, <span class="fl">0.525</span>, <span class="fl">0.5375</span>, <span class="fl">0.55</span>,</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5625</span>, <span class="fl">0.575</span>, <span class="fl">0.5875</span>, <span class="fl">0.6</span>, <span class="fl">0.6125</span>, <span class="fl">0.625</span>, <span class="fl">0.6375</span>, <span class="fl">0.65</span>, <span class="fl">0.6625</span>,</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.675</span>, <span class="fl">0.6875</span>, <span class="fl">0.7</span>, <span class="fl">0.7125</span>, <span class="fl">0.725</span>, <span class="fl">0.7375</span>, <span class="fl">0.75</span>, <span class="fl">0.7625</span>, <span class="fl">0.775</span>,</span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.7875</span>, <span class="fl">0.8</span>, <span class="fl">0.807894737</span>, <span class="fl">0.815789474</span>, <span class="fl">0.823684211</span>, <span class="fl">0.831578947</span>,</span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.839473684</span>, <span class="fl">0.847368421</span>, <span class="fl">0.855263158</span>, <span class="fl">0.863157895</span>, <span class="fl">0.871052632</span>,</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.878947368</span>, <span class="fl">0.886842105</span>, <span class="fl">0.894736842</span>, <span class="fl">0.902631579</span>, <span class="fl">0.910526316</span>,</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.918421053</span>, <span class="fl">0.926315789</span>, <span class="fl">0.934210526</span>, <span class="fl">0.942105263</span>, <span class="fl">0.95</span>, <span class="fl">0.954545455</span>,</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.959090909</span>, <span class="fl">0.963636364</span>, <span class="fl">0.968181818</span>, <span class="fl">0.972727273</span>, <span class="fl">0.977272727</span>,</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.981818182</span>, <span class="fl">0.986363636</span>, <span class="fl">0.990909091</span>, <span class="fl">0.995454545</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="fl">0.989285714</span>, <span class="fl">0.978571429</span>, <span class="fl">0.967857143</span>, <span class="fl">0.957142857</span>, <span class="fl">0.946428571</span>,</span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.935714286</span>, <span class="fl">0.925</span>, <span class="fl">0.914285714</span>, <span class="fl">0.903571429</span>, <span class="fl">0.892857143</span>, <span class="fl">0.882142857</span>,</span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.871428571</span>, <span class="fl">0.860714286</span>, <span class="fl">0.85</span>, <span class="fl">0.839285714</span>, <span class="fl">0.828571429</span>, <span class="fl">0.817857143</span>,</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.807142857</span>, <span class="fl">0.796428571</span>, <span class="fl">0.785714286</span>, <span class="fl">0.775</span>, <span class="fl">0.764285714</span>, <span class="fl">0.753571429</span>,</span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.742857143</span>, <span class="fl">0.732142857</span>, <span class="fl">0.721428571</span>, <span class="fl">0.710714286</span>, <span class="fl">0.7</span></span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>sel_sd <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.05</span>, <span class="fu">length</span>(age))</span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a>p1_prior <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="fl">1.5</span>, <span class="at">cv =</span> <span class="fl">0.4</span>)</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a>p3_prior <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="fl">2.5</span>, <span class="at">cv =</span> <span class="fl">0.6</span>)</span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>p2_prior <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">4</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a>make_prior_data <span class="ot">&lt;-</span> <span class="cf">function</span>(p1_prior, p2_prior, p3_prior) {</span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age,</span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">sel_obs =</span> sel_obs,</span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">sel_sd =</span> sel_sd,</span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_log_p1 =</span> p1_prior<span class="sc">$</span>mu,</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_log_p1 =</span> p1_prior<span class="sc">$</span>sigma,</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_p2 =</span> p2_prior<span class="sc">$</span>mu,</span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_p2 =</span> p2_prior<span class="sc">$</span>sigma,</span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_log_p3 =</span> p3_prior<span class="sc">$</span>mu,</span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_log_p3 =</span> p3_prior<span class="sc">$</span>sigma</span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">make_prior_data</span>(p1_prior, p2_prior, p3_prior)</span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_p1 =</span> <span class="fu">log</span>(<span class="fl">1.5</span>),</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2 =</span> <span class="dv">4</span>,</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_p3 =</span> <span class="fu">log</span>(<span class="fl">2.5</span>)</span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a>make_obj <span class="ot">&lt;-</span> <span class="cf">function</span>(data, parameters) {</span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">function</span>(parms) {</span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getAll</span>(data, parms, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>    p1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_p1)</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a>    p3 <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_p3)</span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a>    sel_hat <span class="ot">&lt;-</span> <span class="fu">dbl_logistic_sel</span>(age, p1, p2, p3)</span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>    nll <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>    nll <span class="ot">&lt;-</span> nll <span class="sc">-</span> <span class="fu">dnorm</span>(log_p1, mu_log_p1, sd_log_p1, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a>    nll <span class="ot">&lt;-</span> nll <span class="sc">-</span> <span class="fu">dnorm</span>(p2, mu_p2, sd_p2, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a>    nll <span class="ot">&lt;-</span> nll <span class="sc">-</span> <span class="fu">dnorm</span>(log_p3, mu_log_p3, sd_log_p3, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ADREPORT</span>(<span class="fu">c</span>(<span class="at">p1 =</span> p1, <span class="at">p2 =</span> p2, <span class="at">p3 =</span> p3))</span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a>    nll</span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MakeADFun</span>(f, parameters)</span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">make_obj</span>(data, parameters)</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(obj<span class="sc">$</span>par, obj<span class="sc">$</span>fn, obj<span class="sc">$</span>gr)</span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a>sdrep <span class="ot">&lt;-</span> <span class="fu">sdreport</span>(obj)</span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a><span class="fu">## MCMC evaluation</span></span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mcmc-run}</span></span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SparseNUTS)</span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>run_snuts <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, data, <span class="at">seed =</span> <span class="dv">1</span>, <span class="at">model_name =</span> <span class="st">"selectivity"</span>) {</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_snuts</span>(</span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a>    obj,</span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_name =</span> model_name,</span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">1</span>,</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_samples =</span> <span class="dv">1150</span>,</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_warmup =</span> <span class="dv">150</span>,</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">globals =</span> <span class="fu">list</span>(<span class="at">dat =</span> data)</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>fit_set1 <span class="ot">&lt;-</span> <span class="fu">run_snuts</span>(obj, data, <span class="at">seed =</span> <span class="dv">1</span>, <span class="at">model_name =</span> <span class="st">"selectivity_set1"</span>)</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mcmc-helpers}</span></span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a>mcmc_selectivity_df <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, age) {</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(fit<span class="sc">$</span>samples[, , <span class="dv">1</span>])</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> fit<span class="sc">$</span>samples[, , <span class="dv">2</span>]</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> <span class="fu">exp</span>(fit<span class="sc">$</span>samples[, , <span class="dv">3</span>])</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(p1, p2, p3) <span class="sc">%&gt;%</span></span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">set =</span> <span class="fu">factor</span>(<span class="fu">row_number</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crossing</span>(<span class="at">age =</span> age) <span class="sc">%&gt;%</span></span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sel =</span> <span class="fu">dbl_logistic_sel</span>(age, p1, p2, p3)) <span class="sc">%&gt;%</span></span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">as.numeric</span>(age)) <span class="sc">%&gt;%</span></span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(set, age)</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a>plot_mcmc_selectivity <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">alpha =</span> <span class="fl">0.1</span>) {</span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, sel, <span class="at">group =</span> set)) <span class="sc">+</span></span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> alpha) <span class="sc">+</span></span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a>    ggthemes<span class="sc">::</span><span class="fu">theme_few</span>()</span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-marginals}</span></span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-marginals</span></span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Marginal posterior distributions for selectivity parameters (SparseNUTS, prior set 1)."</span></span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a>SparseNUTS<span class="sc">::</span><span class="fu">plot_marginals</span>(fit_set1, <span class="at">pars =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a>The marginal posterior densities in @fig-dl-marginals summarize $(p_1, p_2,</span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a>p_3)$ under prior set 1.</span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-pairs}</span></span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-pairs</span></span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Pairwise posterior scatterplots for selectivity parameters."</span></span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit_set1)</span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r posterior-draws-set1}</span></span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-mcmc-set1</span></span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "MCMC selectivity draws for prior set 1 (p1 median 1.5, p3 median 2.5, p2 sd 1)."</span></span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>df_set1 <span class="ot">&lt;-</span> <span class="fu">mcmc_selectivity_df</span>(fit_set1, age)</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mcmc_selectivity</span>(df_set1)</span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additional prior sets</span></span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mcmc-prior-sets}</span></span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a>p1_prior_set2 <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="fl">1.5</span>, <span class="at">cv =</span> <span class="fl">0.4</span>)</span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a>p3_prior_set2 <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="dv">8</span>, <span class="at">cv =</span> <span class="fl">0.6</span>)</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a>p2_prior_set2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">4</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a>data_set2 <span class="ot">&lt;-</span> <span class="fu">make_prior_data</span>(p1_prior_set2, p2_prior_set2, p3_prior_set2)</span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a>obj_set2 <span class="ot">&lt;-</span> <span class="fu">make_obj</span>(data_set2, parameters)</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a>fit_set2 <span class="ot">&lt;-</span> <span class="fu">run_snuts</span>(obj_set2, data_set2, <span class="at">seed =</span> <span class="dv">2</span>, <span class="at">model_name =</span> <span class="st">"selectivity_set2"</span>)</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a>p1_prior_set3 <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="fl">1.5</span>, <span class="at">cv =</span> <span class="fl">0.4</span>)</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a>p3_prior_set3 <span class="ot">&lt;-</span> <span class="fu">lognorm_from_median_cv</span>(<span class="at">median =</span> <span class="dv">8</span>, <span class="at">cv =</span> <span class="fl">0.6</span>)</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a>p2_prior_set3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">4</span>, <span class="at">sigma =</span> <span class="dv">2</span>)</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a>data_set3 <span class="ot">&lt;-</span> <span class="fu">make_prior_data</span>(p1_prior_set3, p2_prior_set3, p3_prior_set3)</span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a>obj_set3 <span class="ot">&lt;-</span> <span class="fu">make_obj</span>(data_set3, parameters)</span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a>fit_set3 <span class="ot">&lt;-</span> <span class="fu">run_snuts</span>(obj_set3, data_set3, <span class="at">seed =</span> <span class="dv">3</span>, <span class="at">model_name =</span> <span class="st">"selectivity_set3"</span>)</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r posterior-draws-set2}</span></span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-mcmc-set2</span></span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "MCMC selectivity draws for prior set 2 (p1 median 1.5, p3 median 8, p2 sd 1)."</span></span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>df_set2 <span class="ot">&lt;-</span> <span class="fu">mcmc_selectivity_df</span>(fit_set2, age)</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mcmc_selectivity</span>(df_set2)</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r posterior-draws-set3}</span></span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dl-mcmc-set3</span></span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "MCMC selectivity draws for prior set 3 (p1 median 1.5, p3 median 8, p2 sd 2)."</span></span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>df_set3 <span class="ot">&lt;-</span> <span class="fu">mcmc_selectivity_df</span>(fit_set3, age)</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mcmc_selectivity</span>(df_set3)</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
</section>
<section id="sec-spline" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="sec-spline"><span class="header-section-number">2.9</span> Spline-Based Selectivity</h2>
</section>
<section id="spline-based-selectivity" class="level1 quarto-embed-nb-cell" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Spline-Based Selectivity</h1>
<p>Penalized B-spline selectivity with smoothness control</p>
<section id="overview-2" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="overview-2"><span class="header-section-number">3.1</span> Overview</h2>
<p>Spline-based selectivity provides a flexible, semi-parametric alternative to logistic functional forms. Rather than imposing a specific shape (monotone or dome-shaped), a B-spline basis is used to represent selectivity as a smooth function of age, with the degree of smoothness controlled by a penalty on the second differences of the spline coefficients.</p>
</section>
<section id="model-definition-2" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="model-definition-2"><span class="header-section-number">3.2</span> Model definition</h2>
<p>Let <span class="math inline">\(\mathbf{B}(a)\)</span> be a B-spline basis matrix evaluated at ages <span class="math inline">\(a\)</span>, with <span class="math inline">\(K\)</span> basis functions and coefficient vector <span class="math inline">\(\boldsymbol{\beta}\)</span>. The log-selectivity is</p>
<p><span class="math display">\[
\log\,\text{sel}(a) = \mathbf{B}(a)\,\boldsymbol{\beta}
\]</span></p>
<p>with selectivity normalized so the maximum equals 1:</p>
<p><span class="math display">\[
\text{sel}(a) = \frac{\exp(\mathbf{B}(a)\,\boldsymbol{\beta})}
{\max_a \exp(\mathbf{B}(a)\,\boldsymbol{\beta})}.
\]</span></p>
<p>Smoothness is enforced via a penalty on second differences:</p>
<p><span class="math display">\[
\text{penalty} = \frac{\lambda}{2} \sum_{k=3}^{K} (\beta_k - 2\beta_{k-1} + \beta_{k-2})^2
\]</span></p>
<p>where <span class="math inline">\(\lambda\)</span> controls the trade-off between fit and smoothness.</p>
</section>
<section id="basis-visualization" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="basis-visualization"><span class="header-section-number">3.3</span> Basis visualization</h2>
<div id="cell-fig-spline-basis" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-spline-basis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spline-basis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/spline_selectivity-fig-spline-basis-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;10: B-spline basis functions for selectivity modeling (K = 6 knots)."><img src="index_files/figure-html/spline_selectivity-fig-spline-basis-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spline-basis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: B-spline basis functions for selectivity modeling (K = 6 knots).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="example-curves" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="example-curves"><span class="header-section-number">3.4</span> Example curves</h2>
<div id="cell-fig-spline-examples" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-spline-examples" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spline-examples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/spline_selectivity-fig-spline-examples-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;11: Example spline selectivity curves with different coefficient vectors."><img src="index_files/figure-html/spline_selectivity-fig-spline-examples-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spline-examples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Example spline selectivity curves with different coefficient vectors.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="rtmb-implementation-1" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="rtmb-implementation-1"><span class="header-section-number">3.5</span> RTMB implementation</h2>
<p><em>Placeholder: RTMB objective with spline coefficients as parameters, smoothness penalty as a tuning parameter or estimated, and MCMC sampling.</em></p>
<div id="d0b9c343-d24c-472d-924f-568091cd8081" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>library(RTMB)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function skeleton</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>f <span class="op">&lt;-</span> function(parms) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  getAll(data, parms, warn <span class="op">=</span> FALSE)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  log_sel <span class="op">&lt;-</span> B <span class="op">%*%</span> beta</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  sel_hat <span class="op">&lt;-</span> exp(log_sel <span class="op">-</span> <span class="bu">max</span>(log_sel))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Second-difference penalty</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  K <span class="op">&lt;-</span> length(beta)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  d2 <span class="op">&lt;-</span> beta[<span class="dv">3</span>:K] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> beta[<span class="dv">2</span>:(K<span class="op">-</span><span class="dv">1</span>)] <span class="op">+</span> beta[<span class="dv">1</span>:(K<span class="op">-</span><span class="dv">2</span>)]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  penalty <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> exp(log_lambda) <span class="op">*</span> <span class="bu">sum</span>(d2<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  nll <span class="op">&lt;-</span> penalty</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add data likelihood here</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nll &lt;- nll - sum(dnorm(sel_obs, sel_hat, sel_sd, log = TRUE))</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  ADREPORT(sel_hat)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  nll</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<!-- -->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Spline-Based Selectivity"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Penalized B-spline selectivity with smoothness control"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>Spline-based selectivity provides a flexible, semi-parametric alternative to</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>logistic functional forms. Rather than imposing a specific shape (monotone or</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>dome-shaped), a B-spline basis is used to represent selectivity as a smooth</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>function of age, with the degree of smoothness controlled by a penalty on the</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>second differences of the spline coefficients.</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model definition</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>Let $\mathbf{B}(a)$ be a B-spline basis matrix evaluated at ages $a$, with $K$</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>basis functions and coefficient vector $\boldsymbol{\beta}$. The log-selectivity is</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>\log\,\text{sel}(a) = \mathbf{B}(a)\,\boldsymbol{\beta}</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>with selectivity normalized so the maximum equals 1:</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>\text{sel}(a) = \frac{\exp(\mathbf{B}(a)\,\boldsymbol{\beta})}</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>{\max_a \exp(\mathbf{B}(a)\,\boldsymbol{\beta})}.</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>Smoothness is enforced via a penalty on second differences:</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>\text{penalty} = \frac{\lambda}{2} \sum_{k=3}^{K} (\beta_k - 2\beta_{k-1} + \beta_{k-2})^2</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>where $\lambda$ controls the trade-off between fit and smoothness.</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Basis visualization</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r basis-plot}</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-spline-basis</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "B-spline basis functions for selectivity modeling (K = 6 knots)."</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">bs</span>(ages, <span class="at">df =</span> K, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>basis_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(B) <span class="sc">%&gt;%</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> ages) <span class="sc">%&gt;%</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="sc">-</span>age, <span class="at">names_to =</span> <span class="st">"basis"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(basis_df, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> value, <span class="at">color =</span> basis)) <span class="sc">+</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Basis function value"</span>,</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"B-spline basis (degree 3, K = 6)"</span>) <span class="sc">+</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example curves</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-curves}</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-spline-examples</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Example spline selectivity curves with different coefficient vectors."</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>spline_sel <span class="ot">&lt;-</span> <span class="cf">function</span>(age, beta, B) {</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>  log_sel <span class="ot">&lt;-</span> B <span class="sc">%*%</span> beta</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_sel <span class="sc">-</span> <span class="fu">max</span>(log_sel))</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(sel)</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>B_mat <span class="ot">&lt;-</span> <span class="fu">bs</span>(ages, <span class="at">df =</span> K, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>examples <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Logistic-like"</span>, <span class="st">"Dome-shaped"</span>, <span class="st">"Bimodal"</span>, <span class="st">"Flat-topped"</span>),</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta =</span> <span class="fu">list</span>(</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>curve_data <span class="ot">&lt;-</span> examples <span class="sc">%&gt;%</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>({</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    ex <span class="ot">&lt;-</span> .</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> ex<span class="sc">$</span>name,</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> ages,</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">selectivity =</span> <span class="fu">spline_sel</span>(ages, ex<span class="sc">$</span>beta, B_mat)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(curve_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span>)) <span class="sc">+</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>, <span class="at">name =</span> <span class="st">"Shape"</span>) <span class="sc">+</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity"</span>,</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Spline selectivity: example shapes"</span>) <span class="sc">+</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## RTMB implementation</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>*Placeholder: RTMB objective with spline coefficients as parameters, smoothness</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>penalty as a tuning parameter or estimated, and MCMC sampling.*</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rtmb-placeholder}</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RTMB)</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function skeleton</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(parms) {</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span>(data, parms, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>  log_sel <span class="ot">&lt;-</span> B <span class="sc">%*%</span> beta</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  sel_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_sel <span class="sc">-</span> <span class="fu">max</span>(log_sel))</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Second-difference penalty</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">length</span>(beta)</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>  d2 <span class="ot">&lt;-</span> beta[<span class="dv">3</span><span class="sc">:</span>K] <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> beta[<span class="dv">2</span><span class="sc">:</span>(K<span class="dv">-1</span>)] <span class="sc">+</span> beta[<span class="dv">1</span><span class="sc">:</span>(K<span class="dv">-2</span>)]</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>  penalty <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">exp</span>(log_lambda) <span class="sc">*</span> <span class="fu">sum</span>(d2<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> penalty</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add data likelihood here</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nll &lt;- nll - sum(dnorm(sel_obs, sel_hat, sel_sd, log = TRUE))</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ADREPORT</span>(sel_hat)</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>  nll</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="sec-timevarying" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="sec-timevarying"><span class="header-section-number">3.6</span> Time-Varying Selectivity with 2D Autoregressive Structure</h2>
</section>
<section id="time-varying-selectivity-with-2d-autoregressive-structure" class="level1 quarto-embed-nb-cell" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Time-Varying Selectivity with 2D Autoregressive Structure</h1>
<p>Separable AR1 processes in year and age via RTMB</p>
<section id="overview-3" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="overview-3"><span class="header-section-number">4.1</span> Overview</h2>
<p>In many fisheries, selectivity is not constant over time. Changes in fishing gear, spatial effort allocation, and fish distribution can all shift the age-specific vulnerability pattern across years. A time-varying selectivity model captures these dynamics by allowing log-selectivity deviations to vary over a year <span class="math inline">\(\times\)</span> age matrix, with temporal and ontogenetic smoothness enforced through a separable two-dimensional autoregressive prior.</p>
<p>This formulation uses RTMB’s <code>dautoreg</code> and <code>dseparable</code> functions to construct a Kronecker-structured precision matrix, providing a computationally efficient and differentiable prior for the year–age deviation surface.</p>
</section>
<section id="model-definition-3" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="model-definition-3"><span class="header-section-number">4.2</span> Model definition</h2>
<section id="selectivity-at-age-by-year" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="selectivity-at-age-by-year"><span class="header-section-number">4.2.1</span> Selectivity-at-age by year</h3>
<p>Let <span class="math inline">\(f\)</span> index fishery, <span class="math inline">\(y\)</span> index year, and <span class="math inline">\(a\)</span> index age. For each fishery, a matrix of log-selectivity deviations <span class="math inline">\(\boldsymbol{\epsilon}_f\)</span> is defined over years <span class="math inline">\(y = 1, \ldots, Y\)</span> and estimated ages <span class="math inline">\(a = a_{\min}, \ldots, a_{\max}\)</span>:</p>
<p><span class="math display">\[
\log s_{f,y,a} = \epsilon_{f,y,a}
\]</span></p>
<p>The realized selectivity is obtained by exponentiating and normalizing so that the mean across ages within each year equals 1:</p>
<p><span class="math display">\[
s_{f,y,a} = \frac{\exp(\epsilon_{f,y,a})}
{\frac{1}{a_{\max} - a_{\min} + 1}\sum_{a'=a_{\min}}^{a_{\max}}
\exp(\epsilon_{f,y,a'})}
\]</span> For ages beyond <span class="math inline">\(a_{\max}\)</span>, selectivity may be held constant at the value for <span class="math inline">\(a_{\max}\)</span> (a “plus-group” extension):</p>
<p><span class="math display">\[
s_{f,y,a} = s_{f,y,a_{\max}}, \qquad a &gt; a_{\max}.
\]</span></p>
</section>
<section id="block-structure-for-change-years" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="block-structure-for-change-years"><span class="header-section-number">4.2.2</span> Block structure for change years</h3>
<p>In practice, selectivity is not re-estimated in every year. Instead, <strong>change years</strong> define blocks within which selectivity is constant. Let <span class="math inline">\(\mathbf{C}_f\)</span> be a binary indicator matrix where <span class="math inline">\(C_{f,y} = 1\)</span> if year <span class="math inline">\(y\)</span> starts a new selectivity block for fishery <span class="math inline">\(f\)</span>. Within a block, selectivity repeats the values from the block’s initial year:</p>
<p><span class="math display">\[
s_{f,y,a} =
\begin{cases}
s_{f,y,a} &amp; \text{if } C_{f,y} = 1 \\
s_{f,y-1,a} &amp; \text{if } C_{f,y} = 0
\end{cases}
\]</span></p>
<p>This reduces the number of free parameters from <span class="math inline">\(Y \times (a_{\max} - a_{\min} + 1)\)</span> to <span class="math inline">\(B_f \times (a_{\max} - a_{\min} + 1)\)</span> where <span class="math inline">\(B_f\)</span> is the number of selectivity blocks for fishery <span class="math inline">\(f\)</span>.</p>
</section>
</section>
<section id="separable-2d-ar1-prior" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="separable-2d-ar1-prior"><span class="header-section-number">4.3</span> Separable 2D AR1 prior</h2>
<section id="marginal-ar1-processes" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="marginal-ar1-processes"><span class="header-section-number">4.3.1</span> Marginal AR1 processes</h3>
<p>The log-selectivity deviations for each fishery are assumed to follow a separable two-dimensional Gaussian Markov random field (GMRF). The key idea is that temporal (year) and ontogenetic (age) correlation structures are modeled independently, and their joint distribution is constructed via a Kronecker product.</p>
<p>Define two stationary AR1 processes:</p>
<p><strong>Year dimension.</strong> For a sequence <span class="math inline">\(x_1, \ldots, x_Y\)</span>:</p>
<p><span class="math display">\[
x_y = \rho_y\, x_{y-1} + \sigma_y\,\eta_y, \qquad \eta_y \sim \mathcal{N}(0,1)
\]</span></p>
<p>where <span class="math inline">\(\rho_y \in (-1, 1)\)</span> is the year-to-year autocorrelation. The marginal variance is <span class="math inline">\(\sigma_y^2 / (1 - \rho_y^2)\)</span> and the precision (inverse covariance) matrix for a length-<span class="math inline">\(Y\)</span> sequence is the tridiagonal matrix <span class="math inline">\(\mathbf{Q}_y\)</span> with:</p>
<p><span class="math display">\[
[\mathbf{Q}_y]_{ij} =
\begin{cases}
1 + \rho_y^2 &amp; i = j,\ 1 &lt; i &lt; Y \\
1 &amp; i = j = 1 \text{ or } i = j = Y \\
-\rho_y &amp; |i - j| = 1 \\
0 &amp; \text{otherwise}
\end{cases}
\]</span></p>
<p>scaled by <span class="math inline">\(1 / \sigma_y^2\)</span>.</p>
<p><strong>Age dimension.</strong> Analogously, for ages <span class="math inline">\(a_{\min}, \ldots, a_{\max}\)</span>:</p>
<p><span class="math display">\[
z_a = \rho_a\, z_{a-1} + \sigma_a\,\nu_a, \qquad \nu_a \sim \mathcal{N}(0,1)
\]</span></p>
<p>with autocorrelation <span class="math inline">\(\rho_a\)</span> and precision matrix <span class="math inline">\(\mathbf{Q}_a\)</span> of the same tridiagonal form.</p>
</section>
<section id="kronecker-product-structure" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="kronecker-product-structure"><span class="header-section-number">4.3.2</span> Kronecker product structure</h3>
<p>The joint precision matrix for the vectorized year–age deviation <span class="math inline">\(\text{vec}(\boldsymbol{\epsilon}_f)\)</span> is the Kronecker product:</p>
<p><span class="math display">\[
\mathbf{Q} = \mathbf{Q}_y \otimes \mathbf{Q}_a
\]</span></p>
<p>This encodes the assumption that the year and age correlation structures are <strong>separable</strong>: the correlation between <span class="math inline">\(\epsilon_{y,a}\)</span> and <span class="math inline">\(\epsilon_{y',a'}\)</span> factorizes as</p>
<p><span class="math display">\[
\text{Cor}(\epsilon_{y,a},\, \epsilon_{y',a'}) = \rho_y^{|y - y'|}\,\rho_a^{|a - a'|}
\]</span></p>
<p>The corresponding joint covariance matrix is:</p>
<p><span class="math display">\[
\boldsymbol{\Sigma} = \boldsymbol{\Sigma}_y \otimes \boldsymbol{\Sigma}_a
\]</span></p>
<p>where <span class="math inline">\(\boldsymbol{\Sigma}_y\)</span> and <span class="math inline">\(\boldsymbol{\Sigma}_a\)</span> are the marginal AR1 covariance matrices for year and age, respectively.</p>
</section>
<section id="marginal-scale" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="marginal-scale"><span class="header-section-number">4.3.3</span> Marginal scale</h3>
<p>The overall marginal standard deviation of any single element <span class="math inline">\(\epsilon_{f,y,a}\)</span> is</p>
<p><span class="math display">\[
\text{SD}(\epsilon_{f,y,a}) = \frac{\sigma_f}
{\sqrt{1 - \rho_{y,f}^2}\;\sqrt{1 - \rho_{a,f}^2}}
\]</span></p>
<p>where <span class="math inline">\(\sigma_f\)</span> is the innovation scale for fishery <span class="math inline">\(f\)</span>. This quantity (<code>scale</code> in the RTMB code) ensures that the specified <span class="math inline">\(\sigma_f\)</span> represents the innovation standard deviation while the marginal variance accounts for both autocorrelation parameters.</p>
</section>
<section id="log-density" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="log-density"><span class="header-section-number">4.3.4</span> Log-density</h3>
<p>The log-density of the separable GMRF, evaluated by RTMB’s <code>dseparable</code>, is:</p>
<p><span class="math display">\[
\log p(\boldsymbol{\epsilon}_f \mid \rho_y, \rho_a, \sigma) =
-\frac{YA}{2}\log(2\pi)
+ \frac{A}{2}\log|\mathbf{Q}_y|
+ \frac{Y}{2}\log|\mathbf{Q}_a|
- \frac{1}{2}\,\text{vec}(\boldsymbol{\epsilon}_f)^\top
\left(\mathbf{Q}_y \otimes \mathbf{Q}_a\right)
\text{vec}(\boldsymbol{\epsilon}_f)
\]</span></p>
<p>where <span class="math inline">\(A = a_{\max} - a_{\min} + 1\)</span> is the number of estimated ages. The Kronecker structure means the log-determinant decomposes as a sum of the individual log-determinants (scaled by dimension), and the quadratic form can be evaluated without materializing the full <span class="math inline">\(YA \times YA\)</span> precision matrix.</p>
</section>
</section>
<section id="rtmb-implementation-2" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="rtmb-implementation-2"><span class="header-section-number">4.4</span> RTMB implementation</h2>
<p>The implementation uses <code>dseparable</code> to compose two <code>dautoreg</code> densities. The <code>dautoreg(x, phi)</code> function evaluates the log-density of an AR1 process with autocorrelation <code>phi</code>, and <code>dseparable(f1, f2)</code> constructs their Kronecker product density.</p>
<div id="4791fef2-0fac-4190-a413-a4a1dd0e366a" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>library(RTMB)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>get_selectivity_prior <span class="op">&lt;-</span> function(rho_y, rho_a, log_sigma, par_log_sel_fya) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  n_sel <span class="op">&lt;-</span> length(par_log_sel_fya)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  lp_sel <span class="op">&lt;-</span> numeric(n_sel)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (f <span class="kw">in</span> seq_len(n_sel)) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marginal scale: sigma / sqrt((1-rho_y^2)(1-rho_a^2))</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">&lt;-</span> exp(log_sigma[f]) <span class="op">/</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      sqrt(<span class="dv">1</span> <span class="op">-</span> rho_y[f]<span class="op">^</span><span class="dv">2</span>) <span class="op">/</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      sqrt(<span class="dv">1</span> <span class="op">-</span> rho_a[f]<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AR1 density in year dimension</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">&lt;-</span> function(x) dautoreg(x, phi <span class="op">=</span> rho_y[f], log <span class="op">=</span> TRUE)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AR1 density in age dimension</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">&lt;-</span> function(x) dautoreg(x, phi <span class="op">=</span> rho_a[f], log <span class="op">=</span> TRUE)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separable 2D density via Kronecker product</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    lp_sel[f] <span class="op">&lt;-</span> <span class="op">-</span>dseparable(f1, f2)(</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      par_log_sel_fya[[f]],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>      scale <span class="op">=</span> scale</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(lp_sel)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="dseparable-mechanics" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="dseparable-mechanics"><span class="header-section-number">4.4.1</span> <code>dseparable</code> mechanics</h3>
<p>The call <code>dseparable(f1, f2)(X, scale)</code> performs the following:</p>
<ol type="1">
<li>Treats the matrix <code>X</code> (dimension <span class="math inline">\(B_f \times A\)</span>) as a 2D random field.</li>
<li>Evaluates <code>f1</code> along each row (year marginal) and <code>f2</code> along each column (age marginal).</li>
<li>Combines them via the Kronecker identity to compute the joint log-density without forming the full <span class="math inline">\(B_f A \times B_f A\)</span> precision matrix.</li>
<li>The <code>scale</code> parameter rescales the entire field so that the marginal standard deviation matches the specified value.</li>
</ol>
<p>This is efficient because the computational cost scales as <span class="math inline">\(\mathcal{O}(B_f \cdot A)\)</span> rather than <span class="math inline">\(\mathcal{O}((B_f \cdot A)^3)\)</span>.</p>
</section>
<section id="selectivity-construction" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="selectivity-construction"><span class="header-section-number">4.4.2</span> Selectivity construction</h3>
<p>The <code>get_selectivity</code> function builds the full 3D array (fishery <span class="math inline">\(\times\)</span> year <span class="math inline">\(\times\)</span> age) from the estimated log-selectivity blocks:</p>
<div id="ffd03b0a-fff6-4e08-9dec-4d0964ad0207" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>get_selectivity <span class="op">&lt;-</span> function(n_age, max_age, first_yr, first_yr_catch,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                            sel_min_age_f, sel_max_age_f, sel_end_f,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                            sel_change_year_fy, par_log_sel) {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  n_sel  <span class="op">&lt;-</span> nrow(sel_change_year_fy)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  n_year <span class="op">&lt;-</span> ncol(sel_change_year_fy)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  ymin   <span class="op">&lt;-</span> first_yr_catch <span class="op">-</span> first_yr <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  sel_fya <span class="op">&lt;-</span> array(<span class="dv">0</span>, dim <span class="op">=</span> c(n_sel, n_year, n_age))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (f <span class="kw">in</span> seq_len(n_sel)) {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    amin <span class="op">&lt;-</span> sel_min_age_f[f] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    amax <span class="op">&lt;-</span> sel_max_age_f[f] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    ipar <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="kw">in</span> ymin:n_year) {</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (sel_change_year_fy[f, y] <span class="op">!=</span> <span class="dv">0</span>) {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># New selectivity block: exponentiate and mean-normalize</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        sel_tmp <span class="op">&lt;-</span> exp(par_log_sel[[f]][ipar, ])</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        ipar <span class="op">&lt;-</span> ipar <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        sel_fya[f, y, amin:amax] <span class="op">&lt;-</span> sel_tmp <span class="op">/</span> mean(sel_tmp)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extend to plus group if needed</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="im">as</span>.logical(sel_end_f[f]) <span class="op">&amp;&amp;</span> amax <span class="op">&lt;</span> max_age) {</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (a <span class="kw">in</span> (amax <span class="op">+</span> <span class="dv">1</span>):n_age) {</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            sel_fya[f, y, a] <span class="op">&lt;-</span> sel_fya[f, y, amax]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Carry forward previous block</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        sel_fya[f, y, ] <span class="op">&lt;-</span> sel_fya[f, y <span class="op">-</span> <span class="dv">1</span>, ]</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(sel_fya)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="visualization" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="visualization"><span class="header-section-number">4.5</span> Visualization</h2>
<div id="cell-fig-tv-sim" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-tv-sim" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tv-sim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/timevarying_selectivity-fig-tv-sim-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;12: Simulated 2D AR1 selectivity surfaces under different autocorrelation settings."><img src="index_files/figure-html/timevarying_selectivity-fig-tv-sim-output-2.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tv-sim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Simulated 2D AR1 selectivity surfaces under different autocorrelation settings.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-tv-lines" class="cell">
<div class="cell-output cell-output-display">
<div id="fig-tv-lines" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tv-lines-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/timevarying_selectivity-fig-tv-lines-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;13: Time-varying selectivity curves at selected years (high autocorrelation scenario)."><img src="index_files/figure-html/timevarying_selectivity-fig-tv-lines-output-1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tv-lines-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Time-varying selectivity curves at selected years (high autocorrelation scenario).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="properties-and-considerations" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="properties-and-considerations"><span class="header-section-number">4.6</span> Properties and considerations</h2>
<p>The separable 2D AR1 formulation has several properties that make it attractive for operational stock assessments:</p>
<p><strong>Parsimony.</strong> Three hyperparameters per fishery (<span class="math inline">\(\rho_y\)</span>, <span class="math inline">\(\rho_a\)</span>, <span class="math inline">\(\sigma\)</span>) control the smoothness of an arbitrarily large year–age surface. The autocorrelation parameters shrink the effective number of free parameters well below the nominal <span class="math inline">\(B_f \times A\)</span>.</p>
<p><strong>Computational efficiency.</strong> The Kronecker structure avoids forming or factorizing the full joint precision matrix. Combined with RTMB’s automatic differentiation, gradients of the log-prior are computed at the same <span class="math inline">\(\mathcal{O}(B_f \cdot A)\)</span> cost as the density itself.</p>
<p><strong>Interpretability.</strong> The parameter <span class="math inline">\(\rho_y\)</span> directly controls how quickly selectivity can change between years (high values produce slow drift, low values allow abrupt shifts), while <span class="math inline">\(\rho_a\)</span> controls the smoothness of the selectivity curve within any single year.</p>
<p><strong>Integration with block structure.</strong> The change-year mechanism can be layered on top: the 2D AR1 prior applies to the matrix of block-specific selectivity patterns, not to every individual year. This reduces dimensionality further while still allowing the prior to borrow strength across blocks.</p>
<!-- -->
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Time-Varying Selectivity with 2D Autoregressive Structure"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Separable AR1 processes in year and age via RTMB"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>In many fisheries, selectivity is not constant over time. Changes in fishing</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>gear, spatial effort allocation, and fish distribution can all shift the</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>age-specific vulnerability pattern across years. A time-varying selectivity</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>model captures these dynamics by allowing log-selectivity deviations to vary</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>over a year $\times$ age matrix, with temporal and ontogenetic smoothness</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>enforced through a separable two-dimensional autoregressive prior.</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>This formulation uses RTMB's <span class="in">`dautoreg`</span> and <span class="in">`dseparable`</span> functions to construct</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>a Kronecker-structured precision matrix, providing a computationally efficient</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>and differentiable prior for the year--age deviation surface.</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model definition</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selectivity-at-age by year</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>Let $f$ index fishery, $y$ index year, and $a$ index age. For each fishery, a</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>matrix of log-selectivity deviations $\boldsymbol{\epsilon}_f$ is defined over</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>years $y = 1, \ldots, Y$ and estimated ages $a = a_{\min}, \ldots, a_{\max}$:</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>\log s_{f,y,a} = \epsilon_{f,y,a}</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>The realized selectivity is obtained by exponentiating and normalizing so that</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>the mean across ages within each year equals 1:</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>s_{f,y,a} = \frac{\exp(\epsilon_{f,y,a})}</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>{\frac{1}{a_{\max} - a_{\min} + 1}\sum_{a'=a_{\min}}^{a_{\max}}</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>\exp(\epsilon_{f,y,a'})}</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>For ages beyond $a_{\max}$, selectivity may be held constant at the value for</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>$a_{\max}$ (a "plus-group" extension):</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>s_{f,y,a} = s_{f,y,a_{\max}}, \qquad a &gt; a_{\max}.</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="fu">### Block structure for change years</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>In practice, selectivity is not re-estimated in every year. Instead,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>**change years** define blocks within which selectivity is constant. Let</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>$\mathbf{C}_f$ be a binary indicator matrix where $C_{f,y} = 1$ if year $y$</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>starts a new selectivity block for fishery $f$. Within a block, selectivity</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>repeats the values from the block's initial year:</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>s_{f,y,a} =</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>\begin{cases}</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>s_{f,y,a} &amp; \text{if } C_{f,y} = 1 <span class="sc">\\</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>s_{f,y-1,a} &amp; \text{if } C_{f,y} = 0</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>This reduces the number of free parameters from $Y \times (a_{\max} - a_{\min} + 1)$</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>to $B_f \times (a_{\max} - a_{\min} + 1)$ where $B_f$ is the number of</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>selectivity blocks for fishery $f$.</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Separable 2D AR1 prior</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal AR1 processes</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>The log-selectivity deviations for each fishery are assumed to follow a</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>separable two-dimensional Gaussian Markov random field (GMRF). The key idea is</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>that temporal (year) and ontogenetic (age) correlation structures are modeled</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>independently, and their joint distribution is constructed via a Kronecker</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>product.</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>Define two stationary AR1 processes:</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>**Year dimension.** For a sequence $x_1, \ldots, x_Y$:</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>x_y = \rho_y\, x_{y-1} + \sigma_y\,\eta_y, \qquad \eta_y \sim \mathcal{N}(0,1)</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>where $\rho_y \in (-1, 1)$ is the year-to-year autocorrelation. The marginal</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>variance is $\sigma_y^2 / (1 - \rho_y^2)$ and the precision (inverse</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>covariance) matrix for a length-$Y$ sequence is the tridiagonal matrix</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>$\mathbf{Q}_y$ with:</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">\mathbf{Q}_y</span><span class="co">]</span>_{ij} =</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>\begin{cases}</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>1 + \rho_y^2 &amp; i = j,\ 1 &lt; i &lt; Y <span class="sc">\\</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>1 &amp; i = j = 1 \text{ or } i = j = Y <span class="sc">\\</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>-\rho_y &amp; |i - j| = 1 <span class="sc">\\</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>0 &amp; \text{otherwise}</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>scaled by $1 / \sigma_y^2$.</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>**Age dimension.** Analogously, for ages $a_{\min}, \ldots, a_{\max}$:</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>z_a = \rho_a\, z_{a-1} + \sigma_a\,\nu_a, \qquad \nu_a \sim \mathcal{N}(0,1)</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>with autocorrelation $\rho_a$ and precision matrix $\mathbf{Q}_a$ of the same</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>tridiagonal form.</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Kronecker product structure</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>The joint precision matrix for the vectorized year--age deviation</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>$\text{vec}(\boldsymbol{\epsilon}_f)$ is the Kronecker product:</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>\mathbf{Q} = \mathbf{Q}_y \otimes \mathbf{Q}_a</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>This encodes the assumption that the year and age correlation structures are</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>**separable**: the correlation between $\epsilon_{y,a}$ and $\epsilon_{y',a'}$</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>factorizes as</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>\text{Cor}(\epsilon_{y,a},\, \epsilon_{y',a'}) = \rho_y^{|y - y'|}\,\rho_a^{|a - a'|}</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>The corresponding joint covariance matrix is:</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>\boldsymbol{\Sigma} = \boldsymbol{\Sigma}_y \otimes \boldsymbol{\Sigma}_a</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>where $\boldsymbol{\Sigma}_y$ and $\boldsymbol{\Sigma}_a$ are the marginal</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>AR1 covariance matrices for year and age, respectively.</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Marginal scale</span></span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>The overall marginal standard deviation of any single element</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>$\epsilon_{f,y,a}$ is</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>\text{SD}(\epsilon_{f,y,a}) = \frac{\sigma_f}</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>{\sqrt{1 - \rho_{y,f}^2}\;\sqrt{1 - \rho_{a,f}^2}}</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>where $\sigma_f$ is the innovation scale for fishery $f$. This quantity</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>(<span class="in">`scale`</span> in the RTMB code) ensures that the specified $\sigma_f$ represents</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>the innovation standard deviation while the marginal variance accounts for</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>both autocorrelation parameters.</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a><span class="fu">### Log-density</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>The log-density of the separable GMRF, evaluated by RTMB's <span class="in">`dseparable`</span>, is:</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>\log p(\boldsymbol{\epsilon}_f \mid \rho_y, \rho_a, \sigma) =</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>-\frac{YA}{2}\log(2\pi)</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>\frac{A}{2}\log|\mathbf{Q}_y|</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>\frac{Y}{2}\log|\mathbf{Q}_a|</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>\frac{1}{2}\,\text{vec}(\boldsymbol{\epsilon}_f)^\top</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>\left(\mathbf{Q}_y \otimes \mathbf{Q}_a\right)</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>\text{vec}(\boldsymbol{\epsilon}_f)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>where $A = a_{\max} - a_{\min} + 1$ is the number of estimated ages. The</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>Kronecker structure means the log-determinant decomposes as a sum of the</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>individual log-determinants (scaled by dimension), and the quadratic form can</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>be evaluated without materializing the full $YA \times YA$ precision matrix.</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a><span class="fu">## RTMB implementation</span></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>The implementation uses <span class="in">`dseparable`</span> to compose two <span class="in">`dautoreg`</span> densities. The</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a><span class="in">`dautoreg(x, phi)`</span> function evaluates the log-density of an AR1 process with</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>autocorrelation <span class="in">`phi`</span>, and <span class="in">`dseparable(f1, f2)`</span> constructs their Kronecker</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>product density.</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rtmb-code}</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RTMB)</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>get_selectivity_prior <span class="ot">&lt;-</span> <span class="cf">function</span>(rho_y, rho_a, log_sigma, par_log_sel_fya) {</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>  n_sel <span class="ot">&lt;-</span> <span class="fu">length</span>(par_log_sel_fya)</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>  lp_sel <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_sel)</span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (f <span class="cf">in</span> <span class="fu">seq_len</span>(n_sel)) {</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marginal scale: sigma / sqrt((1-rho_y^2)(1-rho_a^2))</span></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>    scale <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_sigma[f]) <span class="sc">/</span></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_y[f]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span></span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_a[f]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AR1 density in year dimension</span></span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">dautoreg</span>(x, <span class="at">phi =</span> rho_y[f], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AR1 density in age dimension</span></span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>    f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">dautoreg</span>(x, <span class="at">phi =</span> rho_a[f], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separable 2D density via Kronecker product</span></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>    lp_sel[f] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">dseparable</span>(f1, f2)(</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>      par_log_sel_fya[[f]],</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> scale</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(lp_sel)</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dseparable` mechanics</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>The call <span class="in">`dseparable(f1, f2)(X, scale)`</span> performs the following:</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Treats the matrix <span class="in">`X`</span> (dimension $B_f \times A$) as a 2D random field.</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Evaluates <span class="in">`f1`</span> along each row (year marginal) and <span class="in">`f2`</span> along each column</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>   (age marginal).</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Combines them via the Kronecker identity to compute the joint log-density</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>   without forming the full $B_f A \times B_f A$ precision matrix.</span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>The <span class="in">`scale`</span> parameter rescales the entire field so that the marginal</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>   standard deviation matches the specified value.</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>This is efficient because the computational cost scales as</span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>$\mathcal{O}(B_f \cdot A)$ rather than $\mathcal{O}((B_f \cdot A)^3)$.</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selectivity construction</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>The <span class="in">`get_selectivity`</span> function builds the full 3D array (fishery $\times$</span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>year $\times$ age) from the estimated log-selectivity blocks:</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get-sel-code}</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>get_selectivity <span class="ot">&lt;-</span> <span class="cf">function</span>(n_age, max_age, first_yr, first_yr_catch,</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>                            sel_min_age_f, sel_max_age_f, sel_end_f,</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>                            sel_change_year_fy, par_log_sel) {</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>  n_sel  <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sel_change_year_fy)</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>  n_year <span class="ot">&lt;-</span> <span class="fu">ncol</span>(sel_change_year_fy)</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>  ymin   <span class="ot">&lt;-</span> first_yr_catch <span class="sc">-</span> first_yr <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>  sel_fya <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n_sel, n_year, n_age))</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (f <span class="cf">in</span> <span class="fu">seq_len</span>(n_sel)) {</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>    amin <span class="ot">&lt;-</span> sel_min_age_f[f] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    amax <span class="ot">&lt;-</span> sel_max_age_f[f] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    ipar <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> ymin<span class="sc">:</span>n_year) {</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (sel_change_year_fy[f, y] <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>        <span class="co"># New selectivity block: exponentiate and mean-normalize</span></span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>        sel_tmp <span class="ot">&lt;-</span> <span class="fu">exp</span>(par_log_sel[[f]][ipar, ])</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>        ipar <span class="ot">&lt;-</span> ipar <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>        sel_fya[f, y, amin<span class="sc">:</span>amax] <span class="ot">&lt;-</span> sel_tmp <span class="sc">/</span> <span class="fu">mean</span>(sel_tmp)</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extend to plus group if needed</span></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">as.logical</span>(sel_end_f[f]) <span class="sc">&amp;&amp;</span> amax <span class="sc">&lt;</span> max_age) {</span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (a <span class="cf">in</span> (amax <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n_age) {</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>            sel_fya[f, y, a] <span class="ot">&lt;-</span> sel_fya[f, y, amax]</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Carry forward previous block</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>        sel_fya[f, y, ] <span class="ot">&lt;-</span> sel_fya[f, y <span class="sc">-</span> <span class="dv">1</span>, ]</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sel_fya)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualization</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sim-2d-ar1}</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tv-sim</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Simulated 2D AR1 selectivity surfaces under different autocorrelation settings."</span></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>sim_ar1_2d <span class="ot">&lt;-</span> <span class="cf">function</span>(n_year, n_age, rho_y, rho_a, sigma, <span class="at">seed =</span> <span class="dv">42</span>) {</span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate AR1 in year</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>  y_proc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_year)</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>  y_proc[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_y<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_year) {</span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>    y_proc[t] <span class="ot">&lt;-</span> rho_y <span class="sc">*</span> y_proc[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma)</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate AR1 in age</span></span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>  a_proc <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_age)</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>  a_proc[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> rho_a<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_age) {</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>    a_proc[a] <span class="ot">&lt;-</span> rho_a <span class="sc">*</span> a_proc[a <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma)</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Separable: outer product + noise</span></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">outer</span>(y_proc, a_proc) <span class="sc">+</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n_year <span class="sc">*</span> n_age, <span class="dv">0</span>, sigma <span class="sc">*</span> <span class="fl">0.3</span>), n_year, n_age)</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize each year</span></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(eps, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>    ex <span class="ot">&lt;-</span> <span class="fu">exp</span>(x)</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>    ex <span class="sc">/</span> <span class="fu">mean</span>(ex)</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>  sel</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"High year, high age</span><span class="sc">\n</span><span class="st">(rho_y=0.9, rho_a=0.8)"</span>,</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho_y =</span> <span class="fl">0.9</span>, <span class="at">rho_a =</span> <span class="fl">0.8</span>, <span class="at">sigma =</span> <span class="fl">0.3</span>),</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"High year, low age</span><span class="sc">\n</span><span class="st">(rho_y=0.9, rho_a=0.2)"</span>,</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho_y =</span> <span class="fl">0.9</span>, <span class="at">rho_a =</span> <span class="fl">0.2</span>, <span class="at">sigma =</span> <span class="fl">0.3</span>),</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Low year, high age</span><span class="sc">\n</span><span class="st">(rho_y=0.2, rho_a=0.8)"</span>,</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho_y =</span> <span class="fl">0.2</span>, <span class="at">rho_a =</span> <span class="fl">0.8</span>, <span class="at">sigma =</span> <span class="fl">0.3</span>),</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">label =</span> <span class="st">"Low year, low age</span><span class="sc">\n</span><span class="st">(rho_y=0.2, rho_a=0.2)"</span>,</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho_y =</span> <span class="fl">0.2</span>, <span class="at">rho_a =</span> <span class="fl">0.2</span>, <span class="at">sigma =</span> <span class="fl">0.3</span>)</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>n_year <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>n_age <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">12</span></span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">lapply</span>(<span class="fu">seq_along</span>(scenarios), <span class="cf">function</span>(i) {</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>  sc <span class="ot">&lt;-</span> scenarios[[i]]</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> <span class="fu">sim_ar1_2d</span>(n_year, n_age, sc<span class="sc">$</span>rho_y, sc<span class="sc">$</span>rho_a, sc<span class="sc">$</span>sigma, <span class="at">seed =</span> i)</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span>n_year, <span class="at">age_idx =</span> <span class="dv">1</span><span class="sc">:</span>n_age) <span class="sc">%&gt;%</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> ages[age_idx],</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>      <span class="at">selectivity =</span> <span class="fu">as.vector</span>(sel),</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario =</span> sc<span class="sc">$</span>label</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> year, <span class="at">fill =</span> selectivity)) <span class="sc">+</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>scenario, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Selectivity"</span>, <span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>() <span class="sc">+</span></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Year"</span>,</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Simulated time-varying selectivity surfaces"</span>,</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Separable AR1 in year and age dimensions"</span>) <span class="sc">+</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sim-line-plot}</span></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tv-lines</span></span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Time-varying selectivity curves at selected years (high autocorrelation scenario)."</span></span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>sel_mat <span class="ot">&lt;-</span> <span class="fu">sim_ar1_2d</span>(n_year, n_age, <span class="at">rho_y =</span> <span class="fl">0.9</span>, <span class="at">rho_a =</span> <span class="fl">0.8</span>, <span class="at">sigma =</span> <span class="fl">0.3</span>)</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>sel_df <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span>n_year, <span class="at">age_idx =</span> <span class="dv">1</span><span class="sc">:</span>n_age) <span class="sc">%&gt;%</span></span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> ages[age_idx],</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">selectivity =</span> <span class="fu">as.vector</span>(sel_mat)</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>))</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sel_df, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> selectivity, <span class="at">color =</span> <span class="fu">factor</span>(year))) <span class="sc">+</span></span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"Year"</span>, <span class="at">option =</span> <span class="st">"D"</span>) <span class="sc">+</span></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Selectivity (mean-normalized)"</span>,</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Selectivity-at-age for selected years"</span>) <span class="sc">+</span></span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a><span class="fu">## Properties and considerations</span></span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>The separable 2D AR1 formulation has several properties that make it attractive</span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>for operational stock assessments:</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>**Parsimony.** Three hyperparameters per fishery ($\rho_y$, $\rho_a$, $\sigma$)</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>control the smoothness of an arbitrarily large year--age surface. The</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>autocorrelation parameters shrink the effective number of free parameters well</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>below the nominal $B_f \times A$.</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>**Computational efficiency.** The Kronecker structure avoids forming or</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>factorizing the full joint precision matrix. Combined with RTMB's automatic</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>differentiation, gradients of the log-prior are computed at the same</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>$\mathcal{O}(B_f \cdot A)$ cost as the density itself.</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>**Interpretability.** The parameter $\rho_y$ directly controls how quickly</span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>selectivity can change between years (high values produce slow drift, low</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>values allow abrupt shifts), while $\rho_a$ controls the smoothness of the</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>selectivity curve within any single year.</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>**Integration with block structure.** The change-year mechanism can be layered</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>on top: the 2D AR1 prior applies to the matrix of block-specific selectivity</span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>patterns, not to every individual year. This reduces dimensionality further</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>while still allowing the prior to borrow strength across blocks.</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="sec-discussion" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="sec-discussion"><span class="header-section-number">4.7</span> Comparison and Discussion</h2>
<p><em>Placeholder: comparative analysis across selectivity families, including AIC/BIC, posterior predictive checks, and implications for management quantities.</em></p>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-punt2013" class="csl-entry" role="listitem">
Punt, André E., Felipe Hurtado-Ferro, and Athol R. Whitten. 2013. <span>“Model Selection for Selectivity in Fisheries Stock Assessments.”</span> <em>Fisheries Research</em> 141: 1–12. <a href="https://doi.org/10.1016/j.fishres.2013.02.008">https://doi.org/10.1016/j.fishres.2013.02.008</a>.
</div>
<div id="ref-thompson1994" class="csl-entry" role="listitem">
Thompson, Grant G. 1994. <span>“Confounding of Gear Selectivity and the Natural Mortality Rate in Cases Where the Former Is a Nonmonotone Function of Age.”</span> <em>Canadian Journal of Fisheries and Aquatic Sciences</em> 51 (12): 2654–65. <a href="https://doi.org/10.1139/f94-265">https://doi.org/10.1139/f94-265</a>.
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Selectivity Options for Age-Structured Stock Assessments"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "A comparative framework using RTMB"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: James Ianelli</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: NOAA/NMFS Alaska Fisheries Science Center</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">        city: Seattle</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">        state: WA</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">  Selectivity is a fundamental component of age-structured stock assessment models,</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">  governing how fishing mortality and survey catchability vary with age or size. The</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">  choice of selectivity parameterization affects estimates of population abundance,</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">  fishing mortality, and management reference points. This manuscript compares several</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">  selectivity formulations---including standard logistic, double logistic,</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">  spline-based, and time-varying 2D autoregressive approaches---within a unified</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">  RTMB framework. We examine parameter</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">  identifiability, prior sensitivity, and the practical consequences of selectivity</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">  misspecification using simulation and application to eastern Bering Sea walleye</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">  pollock (*Gadus chalcogrammus*). Results highlight trade-offs between flexibility</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">  and estimability and provide guidance for practitioners choosing among selectivity</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">  options in operational assessments.</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">  - selectivity</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">  - stock assessment</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">  - RTMB</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co">  - fisheries</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">  - walleye pollock</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction {#sec-intro}</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>Selectivity functions describe the relative vulnerability of fish to capture as a</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>function of age (or size) and are among the most influential---yet least</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>observable---components of stock assessment models. The assumed shape of the</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>selectivity curve directly affects estimates of spawning biomass, recruitment, and</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>fishing mortality, and misspecification can propagate into biased reference points</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>and management advice <span class="co">[</span><span class="ot">@punt2013; @thompson1994</span><span class="co">]</span>.</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>Despite its importance, selectivity is often treated as a modelling convenience</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>rather than a biological or technological quantity to be estimated carefully. Most</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>operational assessments adopt a logistic or double-logistic functional form, chosen</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>for parsimony rather than fidelity to the underlying catch process. More flexible</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>alternatives---such as penalized splines or non-parametric approaches---can reduce</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>structural bias but may introduce identifiability problems, particularly when data</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>are sparse or conflicting.</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>This manuscript develops a comparative framework for evaluating selectivity options</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>within the R Template Model Builder (RTMB) environment. RTMB provides automatic</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>differentiation, Laplace approximation for random effects, and integration with</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>Bayesian sampling via SparseNUTS, making it a natural platform for exploring both</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>maximum likelihood and posterior-based inference on selectivity parameters.</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>We organize the comparison around four selectivity families:</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Standard logistic** (@sec-logistic): the two-parameter ascending logistic,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>   widely used for fisheries where retention is assumed to be monotonically</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>   increasing with age.</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Double logistic** (@sec-double-logistic): a dome-shaped three-parameter</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>   formulation allowing selectivity to decline at older ages, motivated by gear</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>   avoidance, ontogenetic habitat shifts, or differential availability.</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Spline-based** (@sec-spline): a penalized B-spline approach offering flexible,</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>   data-driven selectivity shapes with smoothness controlled by a penalty parameter.</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Time-varying 2D AR1** (@sec-timevarying): a separable autoregressive structure</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>   over year and age dimensions, allowing selectivity to evolve smoothly through</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>   time while maintaining age-specific coherence via a Kronecker-structured</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>   precision matrix.</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>For each family, we present the mathematical formulation, an RTMB implementation</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>with prior specification, parameter sensitivity analysis, and MCMC-based posterior</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>evaluation. We then apply all to eastern Bering Sea walleye pollock data to</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>illustrate practical trade-offs.</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## Standard Logistic Selectivity {#sec-logistic}</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>{{&lt; embed logistic_selectivity.qmd &gt;}}</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Double Logistic Selectivity {#sec-double-logistic}</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>{{&lt; embed double_logistic_selectivity.qmd &gt;}}</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spline-Based Selectivity {#sec-spline}</span></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>{{&lt; embed spline_selectivity.qmd &gt;}}</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time-Varying Selectivity with 2D Autoregressive Structure {#sec-timevarying}</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>{{&lt; embed timevarying_selectivity.qmd &gt;}}</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison and Discussion {#sec-discussion}</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>*Placeholder: comparative analysis across selectivity families, including AIC/BIC,</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>posterior predictive checks, and implications for management quantities.*</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a><span class="fu">## References {.unnumbered}</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>::: {#refs}</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>:::</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>